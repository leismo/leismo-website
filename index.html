<p><strong>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</strong> ${coupon.type === 'coupon' ? `‡∏ø${coupon.value}` : `${coupon.value}%`}</p>
                                <p><strong>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</strong> ${coupon.createdDate}</p>
                                <p><strong>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${coupon.expiryDate}</p>
                                <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="${result.status === 'valid' ? 'text-green-600' : result.status === 'used' ? 'text-red-600' : 'text-orange-600'}">${statusText}</span></p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${owner.name}</p>
                                <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${owner.email}</p>
                                <p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</strong> ${owner.tier}</p>
                                <p><strong>‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> ${(owner.points || 0).toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°</p>
                            </div>
                        </div>
                    </div>

                    ${canUse ? `
                        <div class="mt-6 text-center">
                            <button onclick="useCoupon('${coupon.code}', '${owner.uid}')" class="bg-green-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                                ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                            </button>
                        </div>
                    ` : ''}

                    ${result.status === 'used' ? `
                        <div class="mt-4 p-3 bg-red-100 rounded-lg">
                            <p class="text-red-800 text-sm text-center">‚ö†Ô∏è ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ</p>
                        </div>
                    ` : ''}

                    ${result.status === 'expired' ? `
                        <div class="mt-4 p-3 bg-orange-100 rounded-lg">
                            <p class="text-orange-800 text-sm text-center">‚è∞ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showUserCouponsResult(users) {
            const container = document.getElementById('coupon-verification-result');
            container.classList.remove('hidden');

            let html = `
                <div class="border-2 rounded-lg p-6 bg-blue-50 border-blue-200">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2">üë•</div>
                        <h3 class="text-xl font-semibold text-blue-800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                    </div>
            `;

            users.forEach(user => {
                const userCoupons = user.coupons || [];
                const activeCoupons = userCoupons.filter(c => !c.used && new Date() <= new Date(c.expiryTimestamp || c.expiryDate));
                const usedCoupons = userCoupons.filter(c => c.used);
                const expiredCoupons = userCoupons.filter(c => !c.used && new Date() > new Date(c.expiryTimestamp || c.expiryDate));

                html += `
                    <div class="mb-6 p-4 bg-white rounded-lg border">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-semibold text-lg">${user.name}</h4>
                                <p class="text-gray-600">${user.email}</p>
                                <p class="text-sm text-gray-500">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${user.tier} | ‡πÅ‡∏ï‡πâ‡∏°: ${(user.points || 0).toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">
                                    <span class="inline-block bg-green-100 text-green-600 px-2 py-1 rounded text-xs mr-1">‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ${activeCoupons.length}</span>
                                    <span class="inline-block bg-red-100 text-red-600 px-2 py-1 rounded text-xs mr-1">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ${usedCoupons.length}</span>
                                    <span class="inline-block bg-orange-100 text-orange-600 px-2 py-1 rounded text-xs">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${expiredCoupons.length}</span>
                                </div>
                            </div>
                        </div>

                        ${userCoupons.length === 0 ? `
                            <p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                        ` : `
                            <div class="space-y-2">
                                ${userCoupons.slice(0, 3).map(coupon => {
                                    const isExpired = new Date() > new Date(coupon.expiryTimestamp || coupon.expiryDate);
                                    const status = coupon.used ? '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : isExpired ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ';
                                    const statusColor = coupon.used ? 'text-red-600' : isExpired ? 'text-orange-600' : 'text-green-600';
                                    
                                    return `
                                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded text-sm">
                                            <span>${coupon.code} - ${coupon.name}</span>
                                            <span class="${statusColor}">${status}</span>
                                        </div>
                                    `;
                                }).join('')}
                                ${userCoupons.length > 3 ? `<p class="text-gray-500 text-sm text-center">‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${userCoupons.length - 3} ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á...</p>` : ''}
                            </div>
                        `}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Use Coupon Function
        window.useCoupon = async function(couponCode, userId) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ${couponCode}?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`)) {
                return;
            }

            try {
                // Get user data
                const userRef = doc(db, 'users', userId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                    return;
                }

                const userData = userSnap.data();
                const userCoupons = userData.coupons || [];
                
                // Find and update the coupon
                const couponIndex = userCoupons.findIndex(c => c.code === couponCode);
                if (couponIndex === -1) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                    return;
                }

                if (userCoupons[couponIndex].used) {
                    alert('‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }

                // Mark coupon as used
                userCoupons[couponIndex].used = true;
                userCoupons[couponIndex].usedDate = new Date().toLocaleDateString('th-TH');
                userCoupons[couponIndex].usedTimestamp = new Date().toISOString();
                userCoupons[couponIndex].usedByAdmin = window.currentUser.name;

                // Update in Firestore
                await updateDoc(userRef, {
                    coupons: userCoupons
                });

                // Log usage history
                await logCouponUsage(userCoupons[couponIndex], userData);

                alert('‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                
                // Refresh verification result
                showVerificationResult({
                    status: 'used',
                    coupon: userCoupons[couponIndex],
                    owner: userData
                });

                // Refresh usage history
                loadUsageHistory();

            } catch (error) {
                console.error('Use coupon error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á');
            }
        };

        // Usage History Functions
        async function logCouponUsage(coupon, user) {
            try {
                const usageLog = {
                    id: Date.now().toString(),
                    couponCode: coupon.code,
                    couponName: coupon.name,
                    couponValue: coupon.value,
                    couponType: coupon.type,
                    userId: user.uid,
                    userName: user.name,
                    userEmail: user.email,
                    usedDate: coupon.usedDate,
                    usedTimestamp: coupon.usedTimestamp,
                    adminName: window.currentUser.name,
                    adminId: window.currentUser.uid
                };

                // Store in Firestore (you might want a separate collection for this)
                const logRef = doc(db, 'usage_logs', usageLog.id);
                await setDoc(logRef, usageLog);

            } catch (error) {
                console.error('Log usage error:', error);
                // Don't show error to user as this is just logging
            }
        }

        async function loadUsageHistory() {
            try {
                // Get all users and their used coupons
                const usersCollection = collection(db, 'users');
                const usersSnapshot = await getDocs(usersCollection);
                
                let usageHistory = [];

                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userCoupons = userData.coupons || [];
                    
                    userCoupons.forEach(coupon => {
                        if (coupon.used) {
                            usageHistory.push({
                                ...coupon,
                                userName: userData.name,
                                userEmail: userData.email,
                                userTier: userData.tier
                            });
                        }
                    });
                });

                // Sort by used date (newest first)
                usageHistory.sort((a, b) => new Date(b.usedTimestamp || b.usedDate) - new Date(a.usedTimestamp || a.usedDate));

                displayUsageHistory(usageHistory);

            } catch (error) {
                console.error('Load usage history error:', error);
                document.getElementById('usage-history-list').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
                    </div>
                `;
            }
        }

        function displayUsageHistory(history) {
            const container = document.getElementById('usage-history-list');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìä</div>
                        <p class="text-gray-500 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="space-y-4">';
            
            history.forEach((item, index) => {
                const usedDate = item.usedDate || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const adminName = item.usedByAdmin || '‡∏£‡∏∞‡∏ö‡∏ö';
                
                html += `
                    <div class="border rounded-lg p-4 bg-white hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold text-lg">${item.code}</span>
                                    <span class="px-2 py-1 bg-red-100 text-red-600 rounded-full text-xs font-semibold">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</span>
                                </div>
                                <p class="text-gray-700">${item.name}</p>
                                <p class="text-sm text-gray-500">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: ${item.type === 'coupon' ? `‡∏ø${item.value}` : `${item.value}%`}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">${item.userName}</p>
                                <p class="text-sm text-gray-500">${item.userEmail}</p>
                                <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${
                                    item.userTier === 'Platinum' ? 'bg-purple-100 text-purple-600' :
                                    item.userTier === 'Gold' ? 'bg-yellow-100 text-yellow-600' :
                                    item.userTier === 'Silver' ? 'bg-gray-100 text-gray-600' :
                                    'bg-orange-100 text-orange-600'
                                }">${item.userTier}</span>
                            </div>
                        </div>
                        
                        <div class="border-t pt-3 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>üìÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${usedDate}</span>
                                <span>üë§ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢: ${adminName}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        window.filterUsageHistory = function() {
            // This would implement filtering logic
            // For now, just reload all data
            loadUsageHistory();
        };

        // Error handling functions.value}` : `${coupon<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leismo - Fashion Loyalty System</title>
    <!-- Firebase v9 SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .logo-font {
            font-family: 'Playfair Display', serif;
            font-weight: 300;
            letter-spacing: 4px;
            text-transform: lowercase;
        }
        .brand-color { color: #B19D87; }
        .brand-bg { background-color: #B19D87; }
        .brand-border { border-color: #B19D87; }
        .secondary-bg { background-color: #DACFBD; }
        .secondary-border { border-color: #DACFBD; }
        .gradient-bg {
            background: linear-gradient(to right, #B19D87, #DACFBD);
        }
        .hidden { display: none; }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .coupon-modal {
            backdrop-filter: blur(5px);
        }
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .coupon-card {
            background: linear-gradient(135deg, #B19D87 0%, #DACFBD 100%);
            position: relative;
            overflow: hidden;
        }
        .coupon-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b secondary-border">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center gap-8">
                    <!-- Logo with custom positioning -->
                    <div class="cursor-pointer" onclick="showPage('home')">
                        <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-8 w-auto" style="vertical-align: middle; margin-top: -7px;">
                    </div>
                    
                    <!-- Navigation aligned to logo vertical center -->
                    <nav class="hidden md:flex items-center gap-8">
                        <button onclick="showPage('home')" class="font-medium transition-colors text-gray-700 hover:opacity-75 whitespace-nowrap font-onest" style="line-height: 32px; margin-top: 4px; font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;" id="nav-home">
                            ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                        </button>
                        <button onclick="showPage('loyalty')" class="font-medium transition-colors text-gray-700 hover:opacity-75 flex items-center gap-2 whitespace-nowrap hidden font-onest" style="line-height: 32px; margin-top: 4px; font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;" id="nav-loyalty">
                            <span style="margin-top: 2px;">‚≠ê</span>
                            <span>Loyalty Card</span>
                        </button>
                        <button onclick="showPage('admin')" class="font-medium transition-colors text-gray-700 hover:opacity-75 flex items-center gap-2 whitespace-nowrap hidden font-onest" style="line-height: 32px; font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;" id="nav-admin">
                            <span>‚öôÔ∏è</span>
                            <span>Admin Panel</span>
                        </button>
                        <button onclick="showPage('scanner')" class="font-medium transition-colors text-gray-700 hover:opacity-75 flex items-center gap-2 whitespace-nowrap hidden font-onest" style="line-height: 32px; font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;" id="nav-scanner">
                            <span>üì±</span>
                            <span>Coupon Scanner</span>
                        </button>
                    </nav>
                </div>
                
                <!-- Right side buttons -->
                <div class="flex items-center gap-4" id="header-auth">
                    <div class="flex items-center gap-4" id="auth-buttons">
                        <button onclick="showPage('login')" class="hover:opacity-90 transition-colors font-medium brand-color whitespace-nowrap font-onest" style="font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                        <button onclick="showPage('register')" class="bg-transparent border-2 px-4 py-2 rounded-lg hover:bg-opacity-10 transition-colors font-medium brand-color brand-border whitespace-nowrap font-onest" style="font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;">
                            ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-4 hidden" id="user-info">
                        <div class="flex items-center gap-2">
                            <span class="text-yellow-500">‚≠ê</span>
                            <span class="font-semibold brand-color font-onest" style="font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;" id="user-points">0</span>
                            <span class="text-sm text-gray-600 font-onest" style="font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;">‡πÅ‡∏ï‡πâ‡∏°</span>
                        </div>
                        <div class="hidden sm:flex items-center gap-2">
                            <span class="text-gray-600 font-onest" style="font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</span>
                            <span class="font-semibold brand-color font-belgiano" style="font-family: 'Belgiano', serif !important; letter-spacing: 2.5px;" id="user-name"></span>
                        </div>
                        <button onclick="logout()" class="hover:opacity-90 transition-colors font-medium text-gray-600 hover:text-red-600 whitespace-nowrap font-onest" style="font-family: 'Onest', sans-serif !important; letter-spacing: 7.5px;">
                            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Home Page -->
        <div id="page-home" class="min-h-screen flex items-center justify-center gradient-bg">
            <div class="text-center px-4">
                <div class="mb-12">
                    <div class="cursor-pointer mx-auto flex justify-center">
                        <img src="https://i.ibb.co/ds77x4rr/Leismo-Primarylogo-SItypo.png" alt="Leismo Logo" class="h-16 w-auto">
                    </div>
                </div>
                
                <p class="text-xl mb-12 text-white font-light tracking-wide max-w-md mx-auto" style="font-family: 'EthicSerif', serif !important; font-style: italic !important; font-weight: 300 !important; letter-spacing: 2.5px;">
                    A Subtle Weave of Enduring Refinement
                </p>
                
                <div class="space-y-4">
                    <div>
                        <button class="bg-white px-12 py-4 rounded-full font-semibold text-lg hover:bg-opacity-90 transition-colors shadow-lg brand-color">
                            ‡∏î‡∏π‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏Å‡∏ä‡∏±‡∏ô
                        </button>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center" id="home-auth-buttons">
                        <button onclick="showPage('login')" class="border-2 border-white text-white px-8 py-3 rounded-full font-semibold hover:bg-white hover:text-gray-800 transition-colors">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                        
                        <button onclick="showPage('register')" class="bg-white px-8 py-3 rounded-full font-semibold hover:bg-opacity-90 transition-colors brand-color">
                            ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                        </button>
                    </div>

                    <div class="hidden" id="home-loyalty-button">
                        <button onclick="showPage('loyalty')" class="bg-yellow-500 text-white px-8 py-3 rounded-full font-semibold hover:bg-yellow-600 transition-colors shadow-lg">
                            <span class="inline-block mr-2">‚≠ê</span>
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å Loyalty
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Page -->
        <div id="page-login" class="hidden min-h-screen flex items-center justify-center py-12 px-4" style="background: linear-gradient(to bottom right, #DACFBD, #B19D87)">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md border brand-border">
                <div class="text-center mb-6">
                    <div class="cursor-pointer mx-auto mb-4 flex justify-center" onclick="showPage('home')">
                        <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-12 w-auto">
                    </div>
                    <h2 class="text-2xl font-bold tracking-wide brand-color">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                </div>
                
                <div id="login-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
                
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 brand-color">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" id="login-email" required class="w-full p-3 border rounded-lg focus:ring-2 focus:border-transparent font-light secondary-border" placeholder="admin@leismo.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 brand-color">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="login-password" required class="w-full p-3 border rounded-lg focus:ring-2 focus:border-transparent font-light secondary-border" placeholder="admin123">
                    </div>
                    
                    <button type="submit" class="w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-colors shadow-lg brand-bg" id="login-submit">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </form>
                
                <p class="text-center mt-4 text-gray-600 font-light">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <button onclick="showPage('register')" class="hover:underline brand-color">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </p>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-800 font-semibold">üí° ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö Admin:</p>
                    <p class="text-xs text-blue-600">Email: admin@leismo.com</p>
                    <p class="text-xs text-blue-600">Password: admin123</p>
                </div>
                
                <div class="mt-4 p-4 bg-green-50 rounded-lg">
                    <p class="text-sm text-green-800 font-semibold">üî• Firebase Database Connected!</p>
                    <p class="text-xs text-green-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                </div>
            </div>
        </div>

        <!-- Register Page -->
        <div id="page-register" class="hidden min-h-screen flex items-center justify-center py-12 px-4" style="background: linear-gradient(to bottom right, #DACFBD, #B19D87)">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md border brand-border">
                <div class="text-center mb-6">
                    <div class="cursor-pointer mx-auto mb-4 flex justify-center" onclick="showPage('home')">
                        <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-12 w-auto">
                    </div>
                    <h2 class="text-2xl font-bold tracking-wide brand-color">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                </div>
                
                <div id="register-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
                
                <form onsubmit="handleRegister(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 brand-color">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                        <input type="text" id="register-name" required class="w-full p-3 border rounded-lg focus:ring-2 focus:border-transparent font-light secondary-border" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 brand-color">‡∏≠‡∏µ‡πÄ‡∏°‡∏• *</label>
                        <input type="email" id="register-email" required class="w-full p-3 border rounded-lg focus:ring-2 focus:border-transparent font-light secondary-border" placeholder="example@email.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 brand-color">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô *</label>
                        <input type="password" id="register-password" required minlength="6" class="w-full p-3 border rounded-lg focus:ring-2 focus:border-transparent font-light secondary-border" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2 brand-color">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î *</label>
                        <input type="date" id="register-birthdate" required class="w-full p-3 border rounded-lg focus:ring-2 focus:border-transparent font-light secondary-border">
                        <p class="text-xs text-gray-500 mt-1">üéâ ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!</p>
                    </div>
                    
                    <button type="submit" class="w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-colors shadow-lg brand-bg" id="register-submit">
                        ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                    </button>
                </form>
                
                <p class="text-center mt-4 text-gray-600 font-light">
                    ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <button onclick="showPage('login')" class="hover:underline brand-color">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </p>
            </div>
        </div>

        <!-- Loyalty Page -->
        <div id="page-loyalty" class="hidden min-h-screen py-8 px-4 secondary-bg">
            <div class="container mx-auto max-w-6xl">
                <div class="bg-white rounded-lg shadow-lg p-6 md:p-8 border mb-8 brand-border">
                    <h1 class="text-2xl md:text-3xl font-bold mb-6 tracking-wide brand-color">
                        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <span id="loyalty-user-name"></span>
                    </h1>
                    <p class="text-lg mb-8 brand-color">
                        ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å <span id="loyalty-user-tier"></span> | <span id="loyalty-user-points"></span> ‡πÅ‡∏ï‡πâ‡∏°
                    </p>

                    <!-- Navigation Tabs -->
                    <div class="flex flex-col sm:flex-row border-b mb-8 overflow-x-auto">
                        <button onclick="showLoyaltyTab('dashboard')" class="loyalty-tab flex-1 flex items-center justify-center gap-2 py-4 px-6 font-semibold transition-colors whitespace-nowrap border-b-2 brand-color" style="border-color: #B19D87">
                            <span>‚≠ê</span>
                            ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                        </button>
                        <button onclick="showLoyaltyTab('rewards')" class="loyalty-tab flex-1 flex items-center justify-center gap-2 py-4 px-6 font-semibold transition-colors whitespace-nowrap hover:bg-gray-50" style="color: #6B7280; border-color: transparent">
                            <span>üéÅ</span>
                            ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
                        </button>
                        <button onclick="showLoyaltyTab('coupons')" class="loyalty-tab flex-1 flex items-center justify-center gap-2 py-4 px-6 font-semibold transition-colors whitespace-nowrap hover:bg-gray-50" style="color: #6B7280; border-color: transparent">
                            <span>üèÜ</span>
                            ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div id="loyalty-dashboard" class="loyalty-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center p-6 rounded-lg secondary-bg">
                                <div class="text-6xl mb-4">üèÜ</div>
                                <h3 class="text-xl font-semibold mb-2 brand-color">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                                <p class="text-2xl font-bold brand-color" id="dashboard-tier">Bronze</p>
                            </div>
                            
                            <div class="text-center p-6 rounded-lg secondary-bg">
                                <div class="text-6xl mb-4">‚≠ê</div>
                                <h3 class="text-xl font-semibold mb-2 brand-color">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</h3>
                                <p class="text-2xl font-bold brand-color" id="dashboard-points">0</p>
                            </div>
                            
                            <div class="text-center p-6 rounded-lg secondary-bg">
                                <div class="text-6xl mb-4">üéÅ</div>
                                <h3 class="text-xl font-semibold mb-2 brand-color">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ</h3>
                                <p class="text-2xl font-bold brand-color" id="dashboard-coupons">0</p>
                            </div>
                        </div>
                    </div>

                    <div id="loyalty-rewards" class="loyalty-content hidden">
                        <h3 class="text-xl font-semibold mb-6 text-center brand-color">
                            ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="rewards-container">
                            <!-- Rewards will be populated by JavaScript -->
                        </div>
                    </div>

                    <div id="loyalty-coupons" class="loyalty-content hidden">
                        <h3 class="text-xl font-semibold mb-6 text-center brand-color">
                            ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                        </h3>
                        
                        <div id="coupons-container">
                            <!-- Coupons will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="mt-8 p-6 bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg">
                        <h3 class="text-xl font-semibold mb-4 brand-color">üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Loyalty Card</h3>
                        <ol class="list-decimal list-inside space-y-2 text-gray-700">
                            <li>‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á Line Shopping ‡∏´‡∏£‡∏∑‡∏≠ Lazada</li>
                            <li>‡∏ô‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>
                            <li>‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</li>
                            <li>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (1 ‡πÅ‡∏ï‡πâ‡∏°/100 ‡∏ö‡∏≤‡∏ó)</li>
                            <li><strong>‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</strong></li>
                            <li><strong>‡∏ô‡∏≥‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</strong></li>
                        </ol>
                        
                        <div class="mt-6 p-4 bg-white rounded-lg border-l-4 border-yellow-400">
                            <h4 class="font-semibold text-yellow-800 mb-2">üéÇ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h4>
                            <p class="text-sm text-yellow-700">
                                ‚Ä¢ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
                                ‚Ä¢ ‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠<br>
                                ‚Ä¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏û‡∏¥‡πÄ‡∏®‡∏©
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Panel Page -->
        <div id="page-admin" class="hidden min-h-screen py-8 px-4 secondary-bg">
            <div class="container mx-auto max-w-7xl">
                <div class="bg-white rounded-lg shadow-lg p-6 md:p-8 border mb-8 brand-border">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl md:text-3xl font-bold tracking-wide brand-color">
                            üîê Admin Panel
                        </h1>
                        <div class="text-sm text-gray-500">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞: <span class="font-semibold" id="admin-user-name"></span>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-4xl mb-2">üë•</div>
                            <h3 class="text-lg font-semibold mb-2 brand-color">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                            <p class="text-2xl font-bold brand-color" id="total-users">0</p>
                        </div>
                        
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-4xl mb-2">‚≠ê</div>
                            <h3 class="text-lg font-semibold mb-2 brand-color">‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°</h3>
                            <p class="text-2xl font-bold brand-color" id="total-points">0</p>
                        </div>
                        
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-4xl mb-2">üé´</div>
                            <h3 class="text-lg font-semibold mb-2 brand-color">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h3>
                            <p class="text-2xl font-bold brand-color" id="total-coupons">0</p>
                        </div>
                        
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-4xl mb-2">üí∞</div>
                            <h3 class="text-lg font-semibold mb-2 brand-color">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
                            <p class="text-2xl font-bold brand-color" id="total-discount">0‡∏ø</p>
                        </div>
                    </div>

                    <!-- Users List -->
                    <div class="bg-white rounded-lg border brand-border">
                        <div class="p-6 border-b brand-border">
                            <h2 class="text-xl font-semibold brand-color">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="secondary-bg">
                                    <tr>
                                        <th class="text-left p-4 font-semibold brand-color">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                                        <th class="text-left p-4 font-semibold brand-color">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                                        <th class="text-left p-4 font-semibold brand-color">‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                        <th class="text-left p-4 font-semibold brand-color">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                                        <th class="text-left p-4 font-semibold brand-color">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- User Detail Modal -->
                    <div id="user-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                            <!-- Modal Header -->
                            <div class="p-6 border-b brand-border flex justify-between items-center sticky top-0 bg-white">
                                <h2 class="text-2xl font-semibold brand-color">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                                <button onclick="closeUserDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                            </div>

                            <!-- Modal Content -->
                            <div class="p-6">
                                <!-- User Basic Info -->
                                <div class="grid md:grid-cols-2 gap-6 mb-8">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                            <p class="text-lg font-semibold brand-color" id="detail-user-name"></p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                            <p class="text-lg" id="detail-user-email"></p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                                            <p class="text-lg" id="detail-user-created"></p>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                                            <span id="detail-user-tier" class="inline-block px-3 py-1 rounded-full text-sm font-semibold"></span>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</label>
                                            <p class="text-2xl font-bold brand-color">‚≠ê <span id="detail-user-points"></span> ‡πÅ‡∏ï‡πâ‡∏°</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                                            <p class="text-lg">üé´ <span id="detail-user-total-coupons"></span> ‡πÉ‡∏ö</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</label>
                                            <p class="text-lg text-green-600">‚úÖ <span id="detail-user-active-coupons"></span> ‡πÉ‡∏ö</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Coupons History -->
                                <div class="mb-8">
                                    <h3 class="text-xl font-semibold brand-color mb-4">üé´ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h3>
                                    <div id="detail-coupons-container" class="space-y-3">
                                        <!-- Coupons will be populated here -->
                                    </div>
                                </div>

                                <!-- Points Management -->
                                <div class="bg-gray-50 p-6 rounded-lg">
                                    <h3 class="text-xl font-semibold brand-color mb-4">‚ö° ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πâ‡∏°</h3>
                                    <div class="flex gap-4 items-end">
                                        <div class="flex-1">
                                            <label class="block text-sm font-medium text-gray-600 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°</label>
                                            <input type="number" id="detail-points-to-add" min="1" class="w-full p-3 border rounded-lg secondary-border" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°">
                                        </div>
                                        <button onclick="addPointsFromDetail()" class="brand-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90">
                                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Points Modal -->
                    <div id="add-points-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-lg max-w-md w-full mx-4">
                            <h3 class="text-xl font-semibold mb-4 brand-color">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                            
                            <div class="mb-4">
                                <p class="text-gray-600 mb-2">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: <span id="modal-user-name" class="font-semibold"></span></p>
                                <p class="text-gray-600 mb-4">‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="modal-current-points" class="font-semibold"></span> ‡πÅ‡∏ï‡πâ‡∏°</p>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium mb-2 brand-color">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°</label>
                                <input type="number" id="points-to-add" min="1" class="w-full p-3 border rounded-lg secondary-border" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°">
                            </div>
                            
                            <div class="flex gap-4">
                                <button onclick="confirmAddPoints()" class="flex-1 brand-bg text-white py-2 rounded-lg font-semibold hover:opacity-90">
                                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°
                                </button>
                                <button onclick="closeAddPointsModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-semibold hover:opacity-90">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Coupon Modal with QR Code -->
        <div id="coupon-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 coupon-modal">
            <div class="bg-white rounded-2xl max-w-lg w-full max-h-screen overflow-y-auto shadow-2xl">
                <!-- Modal Header -->
                <div class="p-6 border-b brand-border text-center">
                    <div class="text-4xl mb-2">üéâ</div>
                    <h2 class="text-2xl font-bold brand-color">‡πÅ‡∏•‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                    <p class="text-gray-600 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
                </div>

                <!-- Coupon Content -->
                <div class="p-6" id="coupon-content">
                    <!-- Coupon Card -->
                    <div class="coupon-card rounded-2xl p-6 text-white text-center mb-6 shadow-lg">
                        <div class="flex justify-between items-start mb-4">
                            <img src="https://i.ibb.co/ds77x4rr/Leismo-Primarylogo-SItypo.png" alt="Leismo" class="h-8 w-auto">
                            <div class="text-right">
                                <div class="text-2xl font-bold" id="coupon-display-value">‡∏ø100</div>
                                <div class="text-sm opacity-90">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</div>
                            </div>
                        </div>
                        
                        <div class="border-2 border-white border-dashed rounded-lg p-4 mb-4">
                            <div class="text-lg font-semibold mb-2" id="coupon-display-name">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 100‡∏ø</div>
                            <div class="text-xl font-mono tracking-wider font-bold" id="coupon-display-code">LEISMO123456</div>
                        </div>
                        
                        <div class="flex justify-between text-sm opacity-90">
                            <span>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: <span id="coupon-created-date"></span></span>
                            <span>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span id="coupon-expiry-date"></span></span>
                        </div>
                    </div>

                    <!-- QR Code -->
                    <div class="text-center mb-6">
                        <h3 class="text-lg font-semibold mb-4 brand-color">QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
                        <div class="bg-white p-4 rounded-lg border-2 brand-border inline-block">
                            <canvas id="qr-code" class="mx-auto"></canvas>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">‡πÅ‡∏™‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold text-blue-800 mb-2">üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
                        <ol class="text-sm text-blue-700 space-y-1">
                            <li>1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</li>
                            <li>2. ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á Line</li>
                            <li>3. ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</li>
                            <li>4. ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</li>
                        </ol>
                    </div>

                    <!-- Warning -->
                    <div class="bg-orange-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold text-orange-800 mb-2">‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h4>
                        <ul class="text-sm text-orange-700 space-y-1">
                            <li>‚Ä¢ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 7 ‡∏ß‡∏±‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏•‡∏Å</li>
                            <li>‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</li>
                            <li>‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>
                            <li>‚Ä¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ</li>
                        </ul>
                    </div>

                    <!-- Line Contact -->
                    <div class="bg-green-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold text-green-800 mb-2">üì± ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h4>
                        <p class="text-sm text-green-700 mb-2">‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</p>
                        <button class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-600 transition-colors">
                            üì® ‡πÄ‡∏õ‡∏¥‡∏î Line Chat
                        </button>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="p-6 border-t bg-gray-50 flex gap-4">
                    <button onclick="downloadCoupon()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    </button>
                    <button onclick="closeCouponModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                        ‡∏õ‡∏¥‡∏î
                    </button>
                </div>
            </div>
        </div>

        <!-- Coupon Scanner Page -->
        <div id="page-scanner" class="hidden min-h-screen py-8 px-4 secondary-bg">
            <div class="container mx-auto max-w-4xl">
                <div class="bg-white rounded-lg shadow-lg p-6 md:p-8 border mb-8 brand-border">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl md:text-3xl font-bold tracking-wide brand-color">
                            üì± Coupon Scanner
                        </h1>
                        <div class="text-sm text-gray-500">
                            ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: <span class="font-semibold" id="scanner-admin-name"></span>
                        </div>
                    </div>

                    <!-- Scanner Tabs -->
                    <div class="flex flex-col sm:flex-row border-b mb-8 overflow-x-auto">
                        <button onclick="showScannerTab('qr-scan')" class="scanner-tab flex-1 flex items-center justify-center gap-2 py-4 px-6 font-semibold transition-colors whitespace-nowrap border-b-2 brand-color" style="border-color: #B19D87">
                            <span>üì∑</span>
                            ‡∏™‡πÅ‡∏Å‡∏ô QR Code
                        </button>
                        <button onclick="showScannerTab('manual-check')" class="scanner-tab flex-1 flex items-center justify-center gap-2 py-4 px-6 font-semibold transition-colors whitespace-nowrap hover:bg-gray-50" style="color: #6B7280; border-color: transparent">
                            <span>üîç</span>
                            ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™
                        </button>
                        <button onclick="showScannerTab('usage-history')" class="scanner-tab flex-1 flex items-center justify-center gap-2 py-4 px-6 font-semibold transition-colors whitespace-nowrap hover:bg-gray-50" style="color: #6B7280; border-color: transparent">
                            <span>üìä</span>
                            ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ
                        </button>
                    </div>

                    <!-- QR Scanner Tab -->
                    <div id="scanner-qr-scan" class="scanner-content">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üì±</div>
                            <h3 class="text-xl font-semibold mb-4 brand-color">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h3>
                            <p class="text-gray-600 mb-6">‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á QR Code ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡πÅ‡∏Å‡∏ô</p>
                        </div>

                        <!-- QR Scanner Area -->
                        <div class="max-w-md mx-auto mb-8">
                            <div id="qr-scanner-area" class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                <div class="text-4xl mb-4">üì∑</div>
                                <p class="text-gray-600 mb-4">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR Code</p>
                                <button onclick="startQRScanner()" class="brand-bg text-white px-6 py-2 rounded-lg hover:opacity-90" id="start-scanner-btn">
                                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô
                                </button>
                                <div id="qr-scanner-video" class="hidden mt-4">
                                    <video id="scanner-video" class="w-full rounded-lg"></video>
                                    <button onclick="stopQRScanner()" class="mt-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                        ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Input Fallback -->
                        <div class="max-w-md mx-auto">
                            <h4 class="font-semibold mb-4 brand-color">‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR Code ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h4>
                            <div class="space-y-4">
                                <textarea id="qr-data-input" rows="4" class="w-full p-3 border rounded-lg secondary-border" placeholder='‡∏ß‡∏≤‡∏á JSON ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR Code ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...&#10;&#10;‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:&#10;{"type":"LEISMO_COUPON","code":"LEISMO123456",...}'></textarea>
                                <button onclick="processQRData()" class="w-full brand-bg text-white py-3 rounded-lg hover:opacity-90">
                                    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Check Tab -->
                    <div id="scanner-manual-check" class="scanner-content hidden">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üîç</div>
                            <h3 class="text-xl font-semibold mb-4 brand-color">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h3>
                            <p class="text-gray-600 mb-6">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                        </div>

                        <div class="max-w-md mx-auto">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 brand-color">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</label>
                                    <input type="text" id="coupon-code-input" class="w-full p-3 border rounded-lg secondary-border" placeholder="LEISMO123456" style="text-transform: uppercase;">
                                </div>
                                <button onclick="checkCouponCode()" class="w-full brand-bg text-white py-3 rounded-lg hover:opacity-90">
                                    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                                </button>
                            </div>

                            <!-- Quick Search -->
                            <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πà‡∏ß‡∏ô</h4>
                                <div class="space-y-2">
                                    <input type="text" id="user-search-input" class="w-full p-2 border rounded secondary-border" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...">
                                    <button onclick="searchUserCoupons()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Usage History Tab -->
                    <div id="scanner-usage-history" class="scanner-content hidden">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üìä</div>
                            <h3 class="text-xl font-semibold mb-4 brand-color">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h3>
                            <p class="text-gray-600 mb-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                        </div>

                        <!-- Filter Controls -->
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                    <select id="status-filter" class="w-full p-2 border rounded secondary-border">
                                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                        <option value="verified">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
                                        <option value="used">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</option>
                                        <option value="expired">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input type="date" id="date-filter" class="w-full p-2 border rounded secondary-border">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="filterUsageHistory()" class="w-full brand-bg text-white py-2 rounded hover:opacity-90">
                                        ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Usage History List -->
                        <div id="usage-history-list">
                            <!-- History items will be populated here -->
                        </div>
                    </div>

                    <!-- Coupon Verification Result -->
                    <div id="coupon-verification-result" class="hidden mt-8">
                        <!-- Verification results will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="min-h-screen flex items-center justify-center secondary-bg">
            <div class="text-center">
                <div class="mb-4">
                    <img src="https://i.ibb.co/ds77x4rr/Leismo-Primarylogo-SItypo.png" alt="Leismo Logo" class="h-12 w-auto mx-auto">
                </div>
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto mb-4" style="border-color: #B19D87"></div>
                <p class="brand-color">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...</p>
            </div>
        </div>
    </main>

    <script type="module">
        // Firebase Configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBXGkArdsTGXW58iqIas3c9dodTWv0hVuE",
            authDomain: "leismo-website-8f6b0.firebaseapp.com",
            projectId: "leismo-website-8f6b0",
            storageBucket: "leismo-website-8f6b0.firebasestorage.app",
            messagingSenderId: "1085891529571",
            appId: "1:1085891529571:web:9125f49c54ea1de9b96156",
            measurementId: "G-FZQ92YJ9ZN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global Variables
        window.currentUser = null;
        window.isLoggedIn = false;
        window.currentCoupon = null;

        // Rewards Data
        const rewards = [
            { id: 1, name: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 100‡∏ø', points: 500, type: 'coupon', value: 100, description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤' },
            { id: 2, name: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 250‡∏ø', points: 1000, type: 'coupon', value: 250, description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô ‡∏¢‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏î 250 ‡∏ö‡∏≤‡∏ó' },
            { id: 3, name: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 500‡∏ø', points: 2000, type: 'coupon', value: 500, description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 2,000 ‡∏ö‡∏≤‡∏ó‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ' },
            { id: 4, name: '‡∏ü‡∏£‡∏µ‡∏™‡πà‡∏á (‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 50‡∏ø)', points: 300, type: 'coupon', value: 50, description: '‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®' },
            { id: 5, name: '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 15% (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 300‡∏ø)', points: 1500, type: 'percent', value: 15, maxDiscount: 300, description: '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 15% ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 300 ‡∏ö‡∏≤‡∏ó ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥' }
        ];

        // Utility Functions
        function generateCouponCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'LEISMO';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function formatThaiDate(date) {
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function calculateExpiryDate() {
            const now = new Date();
            const expiry = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // 7 days from now
            return expiry;
        }

        // Initialize Admin User
        async function initializeAdminUser() {
            try {
                const adminRef = doc(db, 'users', 'admin_001');
                const adminSnap = await getDoc(adminRef);
                
                if (!adminSnap.exists()) {
                    const adminUser = {
                        uid: 'admin_001',
                        name: 'Admin Leismo',
                        email: 'admin@leismo.com',
                        points: 99999,
                        tier: 'Platinum',
                        isAdmin: true,
                        coupons: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    await setDoc(adminRef, adminUser);
                    console.log('Admin user created');
                }
            } catch (error) {
                console.error('Error initializing admin:', error);
            }
        }

        // Authentication Functions
        window.handleLogin = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const submitBtn = document.getElementById('login-submit');

            if (!email || !password) {
                showError('login-error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                return;
            }

            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            submitBtn.disabled = true;

            try {
                // Check if admin login
                if (email === 'admin@leismo.com' && password === 'admin123') {
                    // Load admin user from Firestore
                    const adminRef = doc(db, 'users', 'admin_001');
                    const adminSnap = await getDoc(adminRef);
                    
                    if (adminSnap.exists()) {
                        window.currentUser = adminSnap.data();
                        window.isLoggedIn = true;
                        updateAuthUI();
                        hideError('login-error');
                        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                        showPage('home');
                    }
                } else {
                    // Regular user login with Firebase Auth
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // Load user data from Firestore
                    const userRef = doc(db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        window.currentUser = userSnap.data();
                        window.isLoggedIn = true;
                        updateAuthUI();
                        hideError('login-error');
                        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                        showPage('home');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('login-error', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            } finally {
                submitBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                submitBtn.disabled = false;
            }
        };

        window.handleRegister = async function(event) {
            event.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const birthDate = document.getElementById('register-birthdate').value;
            const submitBtn = document.getElementById('register-submit');

            if (!name || !email || !password || !birthDate) {
                showError('register-error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            if (password.length < 6) {
                showError('register-error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }

            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£...';
            submitBtn.disabled = true;

            try {
                // Create user with Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Create user document in Firestore
                const userData = {
                    uid: user.uid,
                    name: name,
                    email: email,
                    birthDate: birthDate,
                    points: 100,
                    tier: 'Bronze',
                    coupons: [],
                    isAdmin: false,
                    createdAt: new Date().toISOString()
                };

                await setDoc(doc(db, 'users', user.uid), userData);

                window.currentUser = userData;
                window.isLoggedIn = true;
                updateAuthUI();
                hideError('register-error');
                
                alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Leismo');
                showPage('home');
                
            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showError('register-error', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    showError('register-error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
                }
            } finally {
                submitBtn.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                submitBtn.disabled = false;
            }
        };

        window.logout = async function() {
            try {
                if (window.currentUser && !window.currentUser.isAdmin) {
                    await signOut(auth);
                }
                window.currentUser = null;
                window.isLoggedIn = false;
                updateAuthUI();
                showPage('home');
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Enhanced Coupon Redemption with QR Code
        window.redeemReward = async function(rewardId) {
            if (!window.currentUser) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const reward = rewards.find(r => r.id === rewardId);
            if (!reward) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•');
                return;
            }

            if (window.currentUser.points < reward.points) {
                alert('‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ');
                return;
            }

            // Show loading indicator
            const redeemButton = event.target;
            const originalText = redeemButton.textContent;
            redeemButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏Å...';
            redeemButton.disabled = true;

            try {
                const couponCode = generateCouponCode();
                const createdDate = new Date();
                const expiryDate = calculateExpiryDate();
                
                const newCoupon = {
                    id: Date.now().toString(),
                    code: couponCode,
                    name: reward.name,
                    type: reward.type,
                    value: reward.value,
                    maxDiscount: reward.maxDiscount || null,
                    description: reward.description || '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≤‡∏Å Leismo',
                    used: false,
                    createdDate: formatThaiDate(createdDate),
                    expiryDate: formatThaiDate(expiryDate),
                    createdTimestamp: createdDate.toISOString(),
                    expiryTimestamp: expiryDate.toISOString(),
                    userId: window.currentUser.uid,
                    userName: window.currentUser.name
                };

                // Update user data locally first
                const updatedPoints = window.currentUser.points - reward.points;
                const updatedCoupons = [...(window.currentUser.coupons || []), newCoupon];

                // Update in Firestore
                const userRef = doc(db, 'users', window.currentUser.uid);
                await updateDoc(userRef, {
                    points: updatedPoints,
                    coupons: updatedCoupons
                });

                // Update local user data after successful Firestore update
                window.currentUser.points = updatedPoints;
                window.currentUser.coupons = updatedCoupons;

                // Store current coupon for modal display
                window.currentCoupon = newCoupon;

                // Show coupon modal with QR code
                showCouponModal(newCoupon);

                // Update UI
                updateLoyaltyPage();
                updateAuthUI();

                console.log('Coupon redeemed successfully:', newCoupon);

            } catch (error) {
                console.error('Redeem error:', error);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${error.message}`);
            } finally {
                // Restore button state
                if (redeemButton) {
                    redeemButton.textContent = originalText;
                    redeemButton.disabled = false;
                }
            }
        };

        // Coupon Modal Functions
        function showCouponModal(coupon) {
            try {
                // Populate coupon information
                document.getElementById('coupon-display-name').textContent = coupon.name || '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î';
                document.getElementById('coupon-display-code').textContent = coupon.code || 'LEISMO000000';
                document.getElementById('coupon-created-date').textContent = coupon.createdDate || '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
                document.getElementById('coupon-expiry-date').textContent = coupon.expiryDate || '7 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤';
                
                // Set coupon value display
                const valueDisplay = document.getElementById('coupon-display-value');
                if (coupon.type === 'coupon') {
                    valueDisplay.textContent = `‡∏ø${coupon.value || 0}`;
                } else if (coupon.type === 'percent') {
                    valueDisplay.textContent = `${coupon.value || 0}%`;
                } else {
                    valueDisplay.textContent = `‡∏ø${coupon.value || 0}`;
                }

                // Generate QR Code
                setTimeout(() => {
                    generateQRCode(coupon);
                }, 100);

                // Show modal
                document.getElementById('coupon-modal').classList.remove('hidden');
                
                console.log('Coupon modal shown successfully');
                
            } catch (error) {
                console.error('Error showing coupon modal:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á');
            }
        }

        function generateQRCode(coupon) {
            try {
                const canvas = document.getElementById('qr-code');
                if (!canvas) {
                    console.error('QR Code canvas not found');
                    return;
                }
                
                // QR Code data with coupon verification info
                const qrData = {
                    type: 'LEISMO_COUPON',
                    code: coupon.code || 'UNKNOWN',
                    id: coupon.id || Date.now().toString(),
                    value: coupon.value || 0,
                    couponType: coupon.type || 'coupon',
                    userId: coupon.userId || window.currentUser?.uid || 'unknown',
                    userName: coupon.userName || window.currentUser?.name || 'Unknown User',
                    created: coupon.createdTimestamp || new Date().toISOString(),
                    expiry: coupon.expiryTimestamp || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    verification: `leismo-verify-${coupon.code || 'unknown'}`
                };

                // Generate QR Code with error handling
                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(canvas, JSON.stringify(qrData), {
                        width: 200,
                        height: 200,
                        color: {
                            dark: '#B19D87',
                            light: '#FFFFFF'
                        },
                        errorCorrectionLevel: 'M'
                    }, function(error) {
                        if (error) {
                            console.error('QR Code generation error:', error);
                            // Fallback: draw error message on canvas
                            canvas.width = 200;
                            canvas.height = 200;
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#f0f0f0';
                            ctx.fillRect(0, 0, 200, 200);
                            ctx.fillStyle = '#666';
                            ctx.font = '14px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('QR Code Error', 100, 90);
                            ctx.fillText('Please try again', 100, 110);
                        } else {
                            console.log('QR Code generated successfully');
                        }
                    });
                } else {
                    console.error('QRCode library not loaded');
                    // Fallback for missing library
                    canvas.width = 200;
                    canvas.height = 200;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#e0e0e0';
                    ctx.fillRect(0, 0, 200, 200);
                    ctx.fillStyle = '#666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('QR Library', 100, 90);
                    ctx.fillText('Not Available', 100, 110);
                }
            } catch (error) {
                console.error('Error in generateQRCode:', error);
            }
        }

        window.closeCouponModal = function() {
            document.getElementById('coupon-modal').classList.add('hidden');
            window.currentCoupon = null;
        };

        window.downloadCoupon = function() {
            try {
                if (!window.currentCoupon) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á');
                    return;
                }

                // Create a temporary canvas for the full coupon image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400;
                canvas.height = 600;

                // Background gradient
                const gradient = ctx.createLinearGradient(0, 0, 400, 600);
                gradient.addColorStop(0, '#B19D87');
                gradient.addColorStop(1, '#DACFBD');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 600);

                // Add coupon details as text
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('LEISMO COUPON', 200, 50);

                ctx.font = '18px Arial';
                ctx.fillText(window.currentCoupon.name || '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î', 200, 100);

                ctx.font = 'bold 32px Arial';
                ctx.fillText(window.currentCoupon.code || 'LEISMO000', 200, 150);

                const valueText = window.currentCoupon.type === 'coupon' ? 
                    `‡∏ø${window.currentCoupon.value || 0}` : 
                    `${window.currentCoupon.value || 0}%`;
                ctx.font = 'bold 28px Arial';
                ctx.fillText(valueText, 200, 190);

                ctx.font = '16px Arial';
                ctx.fillText(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${window.currentCoupon.createdDate || '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'}`, 200, 230);
                ctx.fillText(`‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${window.currentCoupon.expiryDate || '7 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤'}`, 200, 260);

                // Add QR code to the canvas if available
                const qrCanvas = document.getElementById('qr-code');
                if (qrCanvas && qrCanvas.width > 0) {
                    ctx.drawImage(qrCanvas, 100, 300, 200, 200);
                } else {
                    // Draw placeholder for QR code
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(100, 300, 200, 200);
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.fillText('QR Code', 200, 410);
                }

                // Add instructions
                ctx.font = '12px Arial';
                ctx.fillText('‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô Line', 200, 540);
                ctx.fillText('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠', 200, 560);

                // Download the image
                const link = document.createElement('a');
                link.download = `leismo-coupon-${window.currentCoupon.code || 'unknown'}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show success message
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô Line');
                
            } catch (error) {
                console.error('Download error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
            }
        };

        // Page Navigation Functions
        window.showPage = function(pageName) {
            const pages = ['home', 'login', 'register', 'loyalty', 'admin', 'scanner'];
            pages.forEach(page => {
                document.getElementById(`page-${page}`).classList.add('hidden');
            });

            document.getElementById(`page-${pageName}`).classList.remove('hidden');
            updateNavigation(pageName);

            if (pageName === 'loyalty') {
                if (!window.isLoggedIn) {
                    showPage('login');
                    return;
                }
                updateLoyaltyPage();
            } else if (pageName === 'admin') {
                if (!window.isLoggedIn || !window.currentUser?.isAdmin) {
                    alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ\n‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    showPage('home');
                    return;
                }
                loadAdminData();
            } else if (pageName === 'scanner') {
                if (!window.isLoggedIn || !window.currentUser?.isAdmin) {
                    alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ\n‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    showPage('home');
                    return;
                }
                loadScannerPage();
            }
        };

        function updateNavigation(currentPage) {
            const navHome = document.getElementById('nav-home');
            const navLoyalty = document.getElementById('nav-loyalty');
            const navAdmin = document.getElementById('nav-admin');
            const navScanner = document.getElementById('nav-scanner');

            // Reset all navigation styles
            [navHome, navLoyalty, navAdmin, navScanner].forEach(nav => {
                if (nav) {
                    nav.style.color = '#6B7280';
                }
            });

            // Highlight current page
            const currentNav = document.getElementById(`nav-${currentPage}`);
            if (currentNav) {
                currentNav.style.color = '#B19D87';
            }
        }

        function updateAuthUI() {
            const authButtons = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');
            const navLoyalty = document.getElementById('nav-loyalty');
            const navAdmin = document.getElementById('nav-admin');
            const homeAuthButtons = document.getElementById('home-auth-buttons');
            const homeLoyaltyButton = document.getElementById('home-loyalty-button');

            if (window.isLoggedIn && window.currentUser) {
                authButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                navLoyalty.classList.remove('hidden');
                
                // Show Admin Panel only for Admin users
                if (window.currentUser.isAdmin) {
                    navAdmin.classList.remove('hidden');
                    document.getElementById('nav-scanner').classList.remove('hidden');
                } else {
                    navAdmin.classList.add('hidden');
                    document.getElementById('nav-scanner').classList.add('hidden');
                }
                
                document.getElementById('user-name').textContent = window.currentUser.name;
                document.getElementById('user-points').textContent = window.currentUser.points?.toLocaleString() || '0';

                homeAuthButtons.classList.add('hidden');
                homeLoyaltyButton.classList.remove('hidden');
            } else {
                authButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
                navLoyalty.classList.add('hidden');
                navAdmin.classList.add('hidden');
                document.getElementById('nav-scanner').classList.add('hidden');

                homeAuthButtons.classList.remove('hidden');
                homeLoyaltyButton.classList.add('hidden');
            }
        }

        // Loyalty Page Functions
        window.showLoyaltyTab = function(tabName) {
            const contents = document.querySelectorAll('.loyalty-content');
            contents.forEach(content => content.classList.add('hidden'));

            document.getElementById(`loyalty-${tabName}`).classList.remove('hidden');

            const tabs = document.querySelectorAll('.loyalty-tab');
            tabs.forEach(tab => {
                tab.style.color = '#6B7280';
                tab.style.borderColor = 'transparent';
                tab.classList.remove('border-b-2');
            });

            event.target.style.color = '#B19D87';
            event.target.style.borderColor = '#B19D87';
            event.target.classList.add('border-b-2');

            if (tabName === 'rewards') {
                loadRewards();
            } else if (tabName === 'coupons') {
                loadCoupons();
            }
        };

        function updateLoyaltyPage() {
            if (!window.currentUser) return;

            document.getElementById('loyalty-user-name').textContent = window.currentUser.name;
            document.getElementById('loyalty-user-tier').textContent = window.currentUser.tier;
            document.getElementById('loyalty-user-points').textContent = window.currentUser.points?.toLocaleString() || '0';

            document.getElementById('dashboard-tier').textContent = window.currentUser.tier;
            document.getElementById('dashboard-points').textContent = window.currentUser.points?.toLocaleString() || '0';
            document.getElementById('dashboard-coupons').textContent = (window.currentUser.coupons || []).filter(c => !c.used).length;
        }

        function loadRewards() {
            const container = document.getElementById('rewards-container');
            container.innerHTML = '';

            rewards.forEach(reward => {
                const canRedeem = window.currentUser && window.currentUser.points >= reward.points;
                const rewardDiv = document.createElement('div');
                rewardDiv.className = 'border rounded-lg p-6 text-center hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1';
                rewardDiv.style.borderColor = '#DACFBD';

                rewardDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="text-6xl mb-2">üéÅ</div>
                        <div class="text-2xl font-bold brand-color mb-1">
                            ${reward.type === 'coupon' ? `‡∏ø${reward.value}` : `${reward.value}%`}
                        </div>
                    </div>
                    
                    <h4 class="font-semibold mb-2 brand-color">${reward.name}</h4>
                    <p class="text-sm text-gray-600 mb-3">${reward.description}</p>
                    <p class="text-2xl font-bold mb-4 brand-color">
                        ${reward.points.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°
                    </p>
                    
                    <button onclick="redeemReward(${reward.id})" 
                            ${!canRedeem ? 'disabled' : ''} 
                            class="w-full py-3 rounded-lg font-semibold transition-all duration-200 ${canRedeem ? 'text-white hover:opacity-90 brand-bg hover:shadow-lg transform hover:scale-105' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}">
                        ${canRedeem ? 'üéØ ‡πÅ‡∏•‡∏Å‡πÄ‡∏•‡∏¢' : '‚ùå ‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠'}
                    </button>
                `;

                container.appendChild(rewardDiv);
            });
        }

        function loadCoupons() {
            const container = document.getElementById('coupons-container');
            const userCoupons = window.currentUser?.coupons || [];

            if (userCoupons.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-8xl mb-4">üéÅ</div>
                        <p class="text-gray-500 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                        <p class="text-gray-400">‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</p>
                        <button onclick="showLoyaltyTab('rewards')" class="mt-4 brand-bg text-white px-6 py-2 rounded-lg hover:opacity-90">
                            ‡πÑ‡∏õ‡πÅ‡∏•‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>';
            const grid = container.querySelector('.grid');

            // Sort coupons by creation date (newest first)
            userCoupons.sort((a, b) => new Date(b.createdTimestamp || b.createdDate) - new Date(a.createdTimestamp || a.createdDate));

            userCoupons.forEach((coupon, index) => {
                const isExpired = new Date() > new Date(coupon.expiryTimestamp || coupon.expiryDate);
                const couponDiv = document.createElement('div');
                couponDiv.className = `border rounded-lg p-6 transition-all duration-200 hover:shadow-lg cursor-pointer ${
                    coupon.used ? 'opacity-50 bg-gray-50 border-gray-300' : 
                    isExpired ? 'opacity-60 bg-red-50 border-red-200' :
                    'bg-white border-dashed hover:scale-105 hover:border-yellow-400'
                }`;
                couponDiv.style.borderColor = coupon.used ? '#ccc' : isExpired ? '#fecaca' : '#B19D87';

                // Add click handler to show coupon modal
                couponDiv.onclick = () => {
                    if (!coupon.used && !isExpired) {
                        window.currentCoupon = coupon;
                        showCouponModal(coupon);
                    }
                };

                const statusIcon = coupon.used ? '‚úÖ' : isExpired ? '‚è∞' : 'üé´';
                const statusText = coupon.used ? '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : isExpired ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ';
                const statusColor = coupon.used ? 'bg-gray-100 text-gray-600' : 
                                   isExpired ? 'bg-red-100 text-red-600' : 
                                   'bg-green-100 text-green-600';

                couponDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg brand-color mb-1">${coupon.name}</h4>
                            <p class="text-sm text-gray-600 mb-2">${coupon.description || '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≤‡∏Å Leismo'}</p>
                            <p class="text-xs text-gray-500">‡πÇ‡∏Ñ‡πâ‡∏î: <span class="font-mono font-semibold">${coupon.code}</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold brand-color">
                                ${coupon.type === 'coupon' ? `‡∏ø${coupon.value}` : `${coupon.value}%`}
                            </p>
                            ${coupon.maxDiscount ? `<p class="text-xs text-gray-500">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏ø${coupon.maxDiscount}</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm text-gray-600">
                            <p>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${coupon.createdDate}</p>
                            <p>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${coupon.expiryDate}</p>
                        </div>
                        <div class="text-center py-2 px-4 rounded-full text-sm font-semibold ${statusColor}">
                            ${statusIcon} ${statusText}
                        </div>
                    </div>

                    ${!coupon.used && !isExpired ? `
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800 mb-2">üí° <strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</strong></p>
                            <p class="text-xs text-blue-600">‚Ä¢ ‡∏î‡∏π QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
                            <p class="text-xs text-blue-600">‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                        </div>
                    ` : ''}

                    ${isExpired && !coupon.used ? `
                        <div class="mt-4 p-3 bg-red-50 rounded-lg">
                            <p class="text-sm text-red-800">‚è∞ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                    ` : ''}

                    ${coupon.used ? `
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600">‚úÖ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                    ` : ''}
                `;

                grid.appendChild(couponDiv);
            });
        }

        // Admin Panel Functions
        async function loadAdminData() {
            try {
                // Load all users from Firestore
                const usersCollection = collection(db, 'users');
                const usersSnapshot = await getDocs(usersCollection);
                const allUsers = [];
                
                usersSnapshot.forEach((doc) => {
                    allUsers.push(doc.data());
                });

                // Calculate statistics
                const totalUsers = allUsers.length;
                const totalPoints = allUsers.reduce((sum, user) => sum + (user.points || 0), 0);
                const totalCoupons = allUsers.reduce((sum, user) => sum + (user.coupons || []).length, 0);
                const totalDiscount = allUsers.reduce((sum, user) => {
                    const userCoupons = user.coupons || [];
                    return sum + userCoupons.reduce((couponSum, coupon) => {
                        return couponSum + (coupon.type === 'coupon' ? coupon.value : 0);
                    }, 0);
                }, 0);

                // Update statistics display
                document.getElementById('admin-user-name').textContent = window.currentUser.name;
                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('total-points').textContent = totalPoints.toLocaleString();
                document.getElementById('total-coupons').textContent = totalCoupons;
                document.getElementById('total-discount').textContent = totalDiscount.toLocaleString();

                // Update users table
                updateUsersTable(allUsers);

            } catch (error) {
                console.error('Error loading admin data:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        function updateUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';

            // Sort users by creation date (newest first)
            users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            users.forEach(user => {
                if (user.isAdmin) return; // Skip admin users in the list

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';

                const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const activeCoupons = (user.coupons || []).filter(c => !c.used).length;

                row.innerHTML = `
                    <td class="p-4">
                        <button onclick="openUserDetailModal('${user.uid}')" class="text-left w-full hover:bg-blue-50 p-2 rounded transition-colors">
                            <div class="font-semibold brand-color hover:text-blue-600 cursor-pointer">${user.name}</div>
                            <div class="text-sm text-gray-500">${user.email}</div>
                        </button>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                            user.tier === 'Platinum' ? 'bg-purple-100 text-purple-600' :
                            user.tier === 'Gold' ? 'bg-yellow-100 text-yellow-600' :
                            user.tier === 'Silver' ? 'bg-gray-100 text-gray-600' :
                            'bg-orange-100 text-orange-600'
                        }">
                            ${user.tier}
                        </span>
                    </td>
                    <td class="p-4">
                        <span class="font-semibold">${(user.points || 0).toLocaleString()}</span> ‡πÅ‡∏ï‡πâ‡∏°
                    </td>
                    <td class="p-4 text-gray-600">${createdDate}</td>
                    <td class="p-4">
                        <button onclick="openAddPointsModal('${user.uid}', '${user.name}', ${user.points || 0})" 
                                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // If no users found (except admin)
            if (users.filter(u => !u.isAdmin).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="p-8 text-center text-gray-500">
                            <div class="text-4xl mb-2">üë•</div>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                        </td>
                    </tr>
                `;
            }
        }

        // User Detail Modal Functions
        let currentDetailUser = null;

        window.openUserDetailModal = async function(userId) {
            try {
                // Get user data from Firestore
                const userRef = doc(db, 'users', userId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                    return;
                }

                currentDetailUser = userSnap.data();
                populateUserDetailModal(currentDetailUser);
                document.getElementById('user-detail-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        };

        function populateUserDetailModal(user) {
            // Basic info
            document.getElementById('detail-user-name').textContent = user.name;
            document.getElementById('detail-user-email').textContent = user.email;
            
            // Birthday
            const birthdateSpan = document.querySelector('#detail-user-birthdate span');
            if (user.birthDate) {
                const birthDate = new Date(user.birthDate);
                birthdateSpan.textContent = birthDate.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } else {
                birthdateSpan.textContent = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            }

            // Created date
            const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            document.getElementById('detail-user-created').textContent = createdDate;

            // Tier
            const tierElement = document.getElementById('detail-user-tier');
            tierElement.textContent = user.tier;
            tierElement.className = `inline-block px-3 py-1 rounded-full text-sm font-semibold ${
                user.tier === 'Platinum' ? 'bg-purple-100 text-purple-600' :
                user.tier === 'Gold' ? 'bg-yellow-100 text-yellow-600' :
                user.tier === 'Silver' ? 'bg-gray-100 text-gray-600' :
                'bg-orange-100 text-orange-600'
            }`;

            // Points and coupons
            document.getElementById('detail-user-points').textContent = (user.points || 0).toLocaleString();
            
            const userCoupons = user.coupons || [];
            const activeCoupons = userCoupons.filter(c => !c.used);
            
            document.getElementById('detail-user-total-coupons').textContent = userCoupons.length;
            document.getElementById('detail-user-active-coupons').textContent = activeCoupons.length;

            // Populate coupons
            populateCouponsHistory(userCoupons);
        }

        function populateCouponsHistory(coupons) {
            const container = document.getElementById('detail-coupons-container');
            
            if (coupons.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üé´</div>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                    </div>
                `;
                return;
            }

            // Sort coupons by creation date (newest first)
            coupons.sort((a, b) => new Date(b.createdTimestamp || b.createdDate) - new Date(a.createdTimestamp || a.createdDate));

            container.innerHTML = '';
            coupons.forEach(coupon => {
                const isExpired = new Date() > new Date(coupon.expiryTimestamp || coupon.expiryDate);
                const couponDiv = document.createElement('div');
                couponDiv.className = `border rounded-lg p-4 ${
                    coupon.used ? 'bg-gray-50 opacity-75' : 
                    isExpired ? 'bg-red-50 opacity-75' :
                    'bg-white border-dashed border-green-300'
                }`;

                couponDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold brand-color">${coupon.name}</h4>
                            <p class="text-sm text-gray-600">‡πÇ‡∏Ñ‡πâ‡∏î: <span class="font-mono font-semibold">${coupon.code}</span></p>
                            <p class="text-sm text-gray-600">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${coupon.createdDate} | ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${coupon.expiryDate}</p>
                            ${coupon.description ? `<p class="text-xs text-gray-500 mt-1">${coupon.description}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold brand-color">
                                ${coupon.type === 'coupon' ? `‡∏ø${coupon.value}` : `${coupon.value}%`}
                            </p>
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${
                                coupon.used ? 'bg-red-100 text-red-600' : 
                                isExpired ? 'bg-orange-100 text-orange-600' :
                                'bg-green-100 text-green-600'
                            }">
                                ${coupon.used ? '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : isExpired ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ'}
                            </span>
                        </div>
                    </div>
                `;

                container.appendChild(couponDiv);
            });
        }

        window.closeUserDetailModal = function() {
            currentDetailUser = null;
            document.getElementById('user-detail-modal').classList.add('hidden');
        };

        window.addPointsFromDetail = async function() {
            const pointsToAdd = parseInt(document.getElementById('detail-points-to-add').value);
            
            if (!pointsToAdd || pointsToAdd <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            if (!currentDetailUser) return;

            try {
                // Update user points in Firestore
                const userRef = doc(db, 'users', currentDetailUser.uid);
                const newPoints = (currentDetailUser.points || 0) + pointsToAdd;
                
                await updateDoc(userRef, {
                    points: newPoints
                });

                // Update current detail user data
                currentDetailUser.points = newPoints;

                // Update the modal display
                document.getElementById('detail-user-points').textContent = newPoints.toLocaleString();
                document.getElementById('detail-points-to-add').value = '';

                alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡πÄ‡∏û‡∏¥‡πà‡∏° ${pointsToAdd.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡πâ ${currentDetailUser.name}`);
                
                // Refresh admin data
                loadAdminData();
                
            } catch (error) {
                console.error('Error adding points:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°');
            }
        };

        // Add Points Modal Functions
        let selectedUserId = null;

        window.openAddPointsModal = function(userId, userName, currentPoints) {
            selectedUserId = userId;
            document.getElementById('modal-user-name').textContent = userName;
            document.getElementById('modal-current-points').textContent = currentPoints.toLocaleString();
            document.getElementById('points-to-add').value = '';
            document.getElementById('add-points-modal').classList.remove('hidden');
        };

        window.closeAddPointsModal = function() {
            selectedUserId = null;
            document.getElementById('add-points-modal').classList.add('hidden');
        };

        window.confirmAddPoints = async function() {
            const pointsToAdd = parseInt(document.getElementById('points-to-add').value);
            
            if (!pointsToAdd || pointsToAdd <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            try {
                // Update user points in Firestore
                const userRef = doc(db, 'users', selectedUserId);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    const newPoints = (userData.points || 0) + pointsToAdd;
                    
                    await updateDoc(userRef, {
                        points: newPoints
                    });

                    alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡πÄ‡∏û‡∏¥‡πà‡∏° ${pointsToAdd.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡πâ ${userData.name}`);
                    closeAddPointsModal();
                    loadAdminData(); // Refresh the data
                }
            } catch (error) {
                console.error('Error adding points:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°');
            }
        };

        // Error handling functions
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError(elementId) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.classList.add('hidden');
        }

        // Initialize the application
        async function init() {
            try {
                // Show loading screen
                document.getElementById('loading-screen').classList.remove('hidden');
                
                // Initialize admin user
                await initializeAdminUser();
                
                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user && user.email !== 'admin@leismo.com') {
                        // Load user data from Firestore
                        const userRef = doc(db, 'users', user.uid);
                        const userSnap = await getDoc(userRef);
                        
                        if (userSnap.exists()) {
                            window.currentUser = userSnap.data();
                            window.isLoggedIn = true;
                            updateAuthUI();
                        }
                    }
                });

                // Hide loading screen and show home page
                document.getElementById('loading-screen').classList.add('hidden');
                showPage('home');
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loading-screen').classList.add('hidden');
                showPage('home');
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î</label>
                                            <p class="text-lg" id="detail-user-birthdate">üéÇ <span></span></p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ß‡∏±‡∏ô
