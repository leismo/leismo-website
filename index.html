<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leismo - Fashion Loyalty System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .brand-color { color: #B19D87; }
        .brand-bg { background-color: #B19D87; }
        .brand-border { border-color: #B19D87; }
        .secondary-bg { background-color: #DACFBD; }
        .gradient-bg { background: linear-gradient(to right, #B19D87, #DACFBD); }
        .hidden { display: none; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .coupon-card {
            background: linear-gradient(135deg, #B19D87 0%, #DACFBD 100%);
        }
        
        /* Member Card Animations */
        .nav-arrow {
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .nav-arrow:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .tier-dot {
            transition: all 0.3s ease;
        }
        .tier-dot:hover {
            background-color: #9CA3AF !important;
        }
        .tier-dot.active {
            background-color: #3B82F6 !important;
            transform: scale(1.4);
        }
        
        #member-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes cardFlip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }
        
        .card-flip {
            animation: cardFlip 0.6s ease-in-out;
        }
        
        /* Credit Card Responsive */
        @media (max-width: 768px) {
            #member-card {
                margin-left: 50px !important;
                margin-right: 50px !important;
                max-width: none;
            }
            .nav-arrow {
                width: 40px;
                height: 40px;
                left: 8px;
                right: 8px;
            }
        }
        
        @media (max-width: 480px) {
            #member-card {
                margin-left: 40px !important;
                margin-right: 40px !important;
                padding: 16px !important;
            }
            .nav-arrow {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b" style="border-color: #DACFBD;">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center gap-8">
                    <div class="cursor-pointer" onclick="showPage('home')">
                        <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-8 w-auto">
                    </div>
                    <nav class="hidden md:flex items-center gap-8">
                        <button onclick="showPage('home')" class="font-medium transition-colors text-gray-700 hover:opacity-75" id="nav-home">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
                        <button onclick="showPage('loyalty')" class="font-medium transition-colors text-gray-700 hover:opacity-75 hidden" id="nav-loyalty">‚≠ê Loyalty Card</button>
                        <button onclick="showPage('admin')" class="font-medium transition-colors text-gray-700 hover:opacity-75 hidden" id="nav-admin">‚öôÔ∏è Admin Panel</button>
                        <button onclick="showPage('scanner')" class="font-medium transition-colors text-gray-700 hover:opacity-75 hidden" id="nav-scanner">üì± Scanner</button>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-4" id="auth-buttons">
                        <button onclick="showPage('login')" class="hover:opacity-90 transition-colors font-medium brand-color">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        <button onclick="showPage('register')" class="bg-transparent border-2 px-4 py-2 rounded-lg hover:bg-opacity-10 transition-colors font-medium brand-color brand-border">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    </div>
                    <div class="flex items-center gap-4 hidden" id="user-info">
                        <div class="flex items-center gap-2">
                            <span class="text-yellow-500">‚≠ê</span>
                            <span class="font-semibold brand-color" id="user-points">0</span>
                            <span class="text-sm text-gray-600">‡πÅ‡∏ï‡πâ‡∏°</span>
                        </div>
                        <span class="text-gray-600">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</span>
                        <span class="font-semibold brand-color" id="user-name"></span>
                        <button onclick="logout()" class="hover:opacity-90 transition-colors font-medium text-gray-600 hover:text-red-600">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Home Page -->
    <div id="page-home" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="text-center px-4">
            <div class="mb-12">
                <img src="https://i.ibb.co/ds77x4rr/Leismo-Primarylogo-SItypo.png" alt="Leismo Logo" class="h-16 w-auto mx-auto">
            </div>
            
            <p class="text-xl mb-12 text-white font-light tracking-wide max-w-md mx-auto" style="font-family: serif; font-style: italic; letter-spacing: 2.5px;">
                A Subtle Weave of Enduring Refinement
            </p>
            
            <div class="space-y-4">
                <button class="bg-white px-12 py-4 rounded-full font-semibold text-lg hover:bg-opacity-90 transition-colors shadow-lg brand-color">
                    ‡∏î‡∏π‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏Å‡∏ä‡∏±‡∏ô
                </button>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center" id="home-auth-buttons">
                    <button onclick="showPage('login')" class="border-2 border-white text-white px-8 py-3 rounded-full font-semibold hover:bg-white hover:text-gray-800 transition-colors">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                    <button onclick="showPage('register')" class="bg-white px-8 py-3 rounded-full font-semibold hover:bg-opacity-90 transition-colors brand-color">
                        ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                    </button>
                </div>

                <div class="hidden" id="home-loyalty-button">
                    <button onclick="showPage('loyalty')" class="bg-yellow-500 text-white px-8 py-3 rounded-full font-semibold hover:bg-yellow-600 transition-colors shadow-lg">
                        <span class="inline-block mr-2">‚≠ê</span>
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å Loyalty
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="page-login" class="hidden min-h-screen flex items-center justify-center py-12 px-4" style="background: linear-gradient(to bottom right, #DACFBD, #B19D87)">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-12 w-auto mx-auto mb-4 cursor-pointer" onclick="showPage('home')">
                <h2 class="text-2xl font-bold brand-color">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            </div>
            
            <div id="login-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="login-email" required class="w-full p-3 border rounded-lg" placeholder="example@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="login-password" required class="w-full p-3 border rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                </div>
                <div class="text-right">
                    <button type="button" onclick="showForgotPasswordModal()" class="text-sm brand-color hover:underline">
                        ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?
                    </button>
                </div>
                <button type="submit" class="w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-colors shadow-lg brand-bg" id="login-submit">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
            
            <p class="text-center mt-4 text-gray-600">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <button onclick="showPage('register')" class="hover:underline brand-color">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            </p>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-800 font-semibold">üí° ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö Admin:</p>
                <p class="text-xs text-blue-600">Email: admin@leismo.com | Password: admin123</p>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="page-register" class="hidden min-h-screen flex items-center justify-center py-12 px-4" style="background: linear-gradient(to bottom right, #DACFBD, #B19D87)">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-12 w-auto mx-auto mb-4 cursor-pointer" onclick="showPage('home')">
                <h2 class="text-2xl font-bold brand-color">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
            </div>
            
            <div id="register-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
            
            <form onsubmit="handleRegister(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                    <input type="text" id="register-name" required class="w-full p-3 border rounded-lg" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">‡∏≠‡∏µ‡πÄ‡∏°‡∏• *</label>
                    <input type="email" id="register-email" required class="w-full p-3 border rounded-lg" placeholder="example@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô *</label>
                    <input type="password" id="register-password" required minlength="6" class="w-full p-3 border rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î *</label>
                    <input type="date" id="register-birthdate" required class="w-full p-3 border rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">üéâ ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!</p>
                </div>
                <button type="submit" class="w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-colors shadow-lg brand-bg" id="register-submit">
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                </button>
            </form>
            
            <p class="text-center mt-4 text-gray-600">
                ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <button onclick="showPage('login')" class="hover:underline brand-color">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </p>
        </div>
    </div>

    <!-- Loyalty Page -->
    <div id="page-loyalty" class="hidden min-h-screen py-8 px-4 secondary-bg">
        <div class="container mx-auto max-w-6xl">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8 border mb-8">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 brand-color">
                    ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <span id="loyalty-user-name"></span>
                </h1>
                
                <!-- Member Card Section -->
                <div class="mb-8">
                    <div class="max-w-5xl mx-auto">
                        <!-- Member Card with Navigation -->
                        <div class="relative">
                            <!-- Member Card (Credit Card Size) -->
                            <div id="member-card" class="relative rounded-2xl p-6 text-white shadow-2xl transition-all duration-500 transform hover:scale-105 mx-16" style="background: linear-gradient(135deg, #526170 0%, #3a4651 100%); aspect-ratio: 16/10; max-width: 600px; margin-left: auto; margin-right: auto;">
                                <!-- Card Content -->
                                <div class="relative z-10 h-full flex flex-col justify-between">
                                    <!-- Top Section -->
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <img src="https://i.ibb.co/ds77x4rr/Leismo-Primarylogo-SItypo.png" alt="Leismo" class="h-6 w-auto mb-3">
                                            <h3 class="text-xl font-bold mb-1" id="card-member-name">Member Name</h3>
                                            <p class="text-xs opacity-90" id="card-member-email">member@email.com</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-3xl mb-1" id="card-tier-icon">ü•â</div>
                                            <div class="text-sm font-semibold" id="card-tier-name">Bronze</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Bottom Section -->
                                    <div class="flex justify-between items-end">
                                        <div>
                                            <p class="text-xs opacity-75 mb-1">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</p>
                                            <p class="text-2xl font-bold" id="card-points">0</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xs opacity-75 mb-1">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</p>
                                            <p class="text-xs font-mono" id="card-member-since">2024</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Card Background Pattern -->
                                <div class="absolute inset-0 overflow-hidden rounded-2xl">
                                    <div class="absolute -top-8 -right-8 w-24 h-24 bg-white opacity-5 rounded-full"></div>
                                    <div class="absolute -bottom-8 -left-8 w-32 h-32 bg-white opacity-5 rounded-full"></div>
                                    <div class="absolute top-1/2 right-4 w-16 h-16 bg-white opacity-5 rounded-full"></div>
                                </div>
                            </div>
                            
                            <!-- Navigation Arrows (Outside Card) -->
                            <button onclick="previousTier()" class="nav-arrow absolute left-2 top-1/2 transform -translate-y-1/2 w-12 h-12 rounded-full bg-white bg-opacity-90 shadow-lg hover:bg-opacity-100 transition-all duration-300 flex items-center justify-center text-gray-700 text-2xl hover:scale-110 z-20" id="prev-arrow">
                                ‚Äπ
                            </button>
                            
                            <button onclick="nextTier()" class="nav-arrow absolute right-2 top-1/2 transform -translate-y-1/2 w-12 h-12 rounded-full bg-white bg-opacity-90 shadow-lg hover:bg-opacity-100 transition-all duration-300 flex items-center justify-center text-gray-700 text-2xl hover:scale-110 z-20" id="next-arrow">
                                ‚Ä∫
                            </button>
                            
                            <!-- Tier Indicator Dots -->
                            <div class="flex justify-center mt-6 space-x-3">
                                <button onclick="showTierCard('bronze')" class="tier-dot w-3 h-3 rounded-full transition-all duration-300 hover:scale-125 bg-gray-300" id="dot-bronze"></button>
                                <button onclick="showTierCard('silver')" class="tier-dot w-3 h-3 rounded-full transition-all duration-300 hover:scale-125 bg-gray-300" id="dot-silver"></button>
                                <button onclick="showTierCard('gold')" class="tier-dot w-3 h-3 rounded-full transition-all duration-300 hover:scale-125 bg-gray-300" id="dot-gold"></button>
                                <button onclick="showTierCard('platinum')" class="tier-dot w-3 h-3 rounded-full transition-all duration-300 hover:scale-125 bg-gray-300" id="dot-platinum"></button>
                            </div>
                        </div>
                        
                        <!-- Tier Info -->
                        <div class="mt-6 p-6 bg-white rounded-lg shadow-md border-l-4 border-blue-500 max-w-2xl mx-auto">
                            <h4 class="text-lg font-semibold mb-3 brand-color flex items-center">
                                <span class="mr-2">üí°</span> 
                                <span id="current-tier-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Bronze</span>
                            </h4>
                            <div class="text-sm text-gray-700 space-y-1" id="tier-info">
                                <p>‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: 0-5,000‡∏ø</p>
                                <p>‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: 5%</p>
                                <p>‚Ä¢ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©: 1/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Tabs -->
                <div class="flex border-b mb-8">
                    <button onclick="showLoyaltyTab('dashboard')" class="loyalty-tab flex-1 py-4 px-6 font-semibold transition-colors border-b-2 brand-color" style="border-color: #B19D87; color: #B19D87;">
                        ‚≠ê ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                    </button>
                    <button onclick="showLoyaltyTab('rewards')" class="loyalty-tab flex-1 py-4 px-6 font-semibold transition-colors text-gray-600 hover:bg-gray-50">
                        üéÅ ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
                    </button>
                    <button onclick="showLoyaltyTab('coupons')" class="loyalty-tab flex-1 py-4 px-6 font-semibold transition-colors text-gray-600 hover:bg-gray-50">
                        üèÜ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                    </button>
                </div>

                <!-- Dashboard Tab -->
                <div id="loyalty-dashboard" class="loyalty-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-6xl mb-4">üèÜ</div>
                            <h3 class="text-xl font-semibold mb-2 brand-color">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                            <p class="text-2xl font-bold brand-color" id="dashboard-tier">Bronze</p>
                        </div>
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-6xl mb-4">‚≠ê</div>
                            <h3 class="text-xl font-semibold mb-2 brand-color">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</h3>
                            <p class="text-2xl font-bold brand-color" id="dashboard-points">0</p>
                        </div>
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-6xl mb-4">üéÅ</div>
                            <h3 class="text-xl font-semibold mb-2 brand-color">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ</h3>
                            <p class="text-2xl font-bold brand-color" id="dashboard-coupons">0</p>
                        </div>
                    </div>
                </div>

                <!-- Rewards Tab -->
                <div id="loyalty-rewards" class="loyalty-content hidden">
                    <h3 class="text-xl font-semibold mb-6 text-center brand-color">‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="rewards-container">
                        <!-- Rewards will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Coupons Tab -->
                <div id="loyalty-coupons" class="loyalty-content hidden">
                    <h3 class="text-xl font-semibold mb-6 text-center brand-color">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
                    <div id="coupons-container">
                        <!-- Coupons will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="page-admin" class="hidden min-h-screen py-8 px-4 secondary-bg">
        <div class="container mx-auto max-w-7xl">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 brand-color">üîê Admin Panel</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="text-center p-6 rounded-lg secondary-bg">
                        <div class="text-4xl mb-2">üë•</div>
                        <h3 class="text-lg font-semibold mb-2 brand-color">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <p class="text-2xl font-bold brand-color" id="admin-total-users">-</p>
                    </div>
                    <div class="text-center p-6 rounded-lg secondary-bg">
                        <div class="text-4xl mb-2">‚≠ê</div>
                        <h3 class="text-lg font-semibold mb-2 brand-color">‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°</h3>
                        <p class="text-2xl font-bold brand-color" id="admin-total-points">-</p>
                    </div>
                    <div class="text-center p-6 rounded-lg secondary-bg">
                        <div class="text-4xl mb-2">üé´</div>
                        <h3 class="text-lg font-semibold mb-2 brand-color">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h3>
                        <p class="text-2xl font-bold brand-color" id="admin-total-coupons">-</p>
                    </div>
                    <div class="text-center p-6 rounded-lg secondary-bg">
                        <div class="text-4xl mb-2">üí∞</div>
                        <h3 class="text-lg font-semibold mb-2 brand-color">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
                        <p class="text-2xl font-bold brand-color" id="admin-total-value">-</p>
                    </div>
                </div>
                
                <div class="bg-white border rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 brand-color">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                    <div id="admin-users-list" class="space-y-4">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl">
            <div class="p-6 border-b text-center">
                <div class="text-4xl mb-2">üîë</div>
                <h2 class="text-2xl font-bold brand-color">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
                <p class="text-gray-600 mt-2">‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
            </div>
            
            <div class="p-6">
                <div id="forgot-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
                <div id="forgot-success" class="hidden mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded"></div>
                
                <form onsubmit="handleForgotPassword(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 brand-color">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                        <input type="email" id="forgot-email" required class="w-full p-3 border rounded-lg" placeholder="example@email.com">
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-blue-800 mb-2">üìß ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
                        <ol class="text-sm text-blue-700 space-y-1">
                            <li>1. ‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</li>
                            <li>2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•</li>
                            <li>3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Spam)</li>
                            <li>4. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</li>
                        </ol>
                    </div>
                    
                    <button type="submit" class="w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-colors shadow-lg brand-bg" id="forgot-submit">
                        üì® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                    </button>
                </form>
            </div>

            <div class="p-6 border-t bg-gray-50 flex gap-4">
                <button onclick="closeForgotPasswordModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                    ‚úï ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="user-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl max-w-4xl w-full shadow-2xl my-8 max-h-screen overflow-y-auto">
            <div class="p-6 border-b text-center sticky top-0 bg-white rounded-t-2xl">
                <div class="text-4xl mb-2">üë§</div>
                <h2 class="text-2xl font-bold brand-color">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                <p class="text-gray-600 mt-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
            </div>
            
            <div class="p-6">
                <!-- Personal Info -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 brand-color flex items-center">
                        <span class="mr-2">üìã</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                    </h3>
                    <div class="grid md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg">
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-medium text-gray-600">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                <p class="font-semibold" id="user-detail-name">-</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <p class="font-mono text-sm" id="user-detail-email">-</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                                <p class="text-sm" id="user-detail-birthdate">-</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-medium text-gray-600">User ID</label>
                                <p class="font-mono text-xs bg-gray-200 p-2 rounded break-all" id="user-detail-uid">-</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                <p class="text-sm" id="user-detail-created">-</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                                <p class="font-semibold" id="user-detail-tier">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Points Info -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 brand-color flex items-center">
                        <span class="mr-2">‚≠ê</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πâ‡∏°
                    </h3>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-4xl font-bold brand-color mb-2" id="user-detail-points">0</div>
                        <p class="text-gray-600">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                    </div>
                </div>

                <!-- Coupons Info -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4 brand-color flex items-center">
                        <span class="mr-2">üé´</span> ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="user-detail-coupon-count">0</span> ‡πÉ‡∏ö)
                    </h3>
                    <div id="user-detail-coupons">
                        <!-- Coupons will be populated here -->
                    </div>
                </div>
            </div>

            <div class="p-6 border-t bg-gray-50 flex gap-4 sticky bottom-0 rounded-b-2xl">
                <button onclick="editUserPoints()" class="flex-1 bg-yellow-500 text-white py-3 rounded-lg font-semibold hover:bg-yellow-600 transition-colors">
                    ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ï‡πâ‡∏°
                </button>
                <button onclick="resetUserPassword()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                    üîë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                </button>
                <button onclick="closeUserDetailsModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                    ‚úï ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- Coupon Verification Page (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô) -->
    <div id="page-verify" class="hidden min-h-screen py-8 px-4 secondary-bg">
        <div class="container mx-auto max-w-2xl">
            <!-- Admin Authentication -->
            <div id="admin-auth-section" class="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">üîê</div>
                    <h1 class="text-2xl font-bold brand-color">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h1>
                    <p class="text-gray-600 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                </div>
                
                <div id="admin-verify-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
                
                <form onsubmit="verifyAdminAccess(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 brand-color">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
                        <input type="password" id="admin-verify-password" required class="w-full p-3 border rounded-lg" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô">
                    </div>
                    <button type="submit" class="w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-colors shadow-lg brand-bg" id="admin-verify-submit">
                        üîì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    </button>
                </form>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-800">üí° <strong>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:</strong> admin123</p>
                </div>
            </div>

            <!-- Coupon Check Section (‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô) -->
            <div id="coupon-check-section" class="hidden bg-white rounded-lg shadow-lg p-6 md:p-8">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">üé´</div>
                    <h1 class="text-2xl font-bold brand-color">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h1>
                    <p class="text-gray-600 mt-2">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á: <span class="font-mono font-bold" id="checking-coupon-code"></span></p>
                </div>

                <div id="coupon-status-result">
                    <!-- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
            </div>
        </div>
    </div>
    <div id="page-scanner" class="hidden min-h-screen py-8 px-4 secondary-bg">
        <div class="container mx-auto max-w-4xl">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 brand-color">üì± ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h1>
                
                <!-- Tab Navigation -->
                <div class="flex border-b mb-8">
                    <button onclick="showScannerTab('qr')" class="scanner-tab flex-1 py-4 px-6 font-semibold transition-colors border-b-2 brand-color" style="border-color: #B19D87; color: #B19D87;" id="tab-qr">
                        üì± ‡∏™‡πÅ‡∏Å‡∏ô QR Code
                    </button>
                    <button onclick="showScannerTab('code')" class="scanner-tab flex-1 py-4 px-6 font-semibold transition-colors text-gray-600 hover:bg-gray-50" id="tab-code">
                        üî§ ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                    </button>
                </div>

                <!-- QR Scanner Tab -->
                <div id="scanner-qr" class="scanner-content">
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">üìù</div>
                        <h3 class="text-xl font-semibold mb-4 brand-color">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠ QR Code</h3>
                        <p class="text-gray-600 mb-6">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á JSON ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR Code</p>
                    </div>
                    
                    <div class="max-w-md mx-auto">
                        <h4 class="font-semibold mb-4 brand-color">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ JSON ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR Code</h4>
                        <div class="space-y-4">
                            <textarea id="qr-data-input" rows="4" class="w-full p-3 border rounded-lg" placeholder='‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á: LEISMO123456

‡∏´‡∏£‡∏∑‡∏≠ JSON ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR Code:
{"type":"LEISMO_COUPON","code":"LEISMO123456",...}'></textarea>
                            <button onclick="processQRData()" class="w-full brand-bg text-white py-3 rounded-lg hover:opacity-90 font-semibold">
                                üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-green-50 rounded-lg">
                            <h5 class="font-semibold text-green-800 mb-2">üí° ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</h5>
                            <ul class="text-sm text-green-700 space-y-1">
                                <li>‚Ä¢ <strong>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á:</strong> LEISMO123456</li>
                                <li>‚Ä¢ <strong>JSON QR Code:</strong> {"type":"LEISMO_COUPON",...}</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Code Input Tab -->
                <div id="scanner-code" class="scanner-content hidden">
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">üî§</div>
                        <h3 class="text-xl font-semibold mb-4 brand-color">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h3>
                        <p class="text-gray-600 mb-6">‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    </div>
                    
                    <div class="max-w-md mx-auto">
                        <h4 class="font-semibold mb-4 brand-color">‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h4>
                        <div class="space-y-4">
                            <div class="relative">
                                <input type="text" id="coupon-code-input" class="w-full p-4 border rounded-lg text-center font-mono text-lg tracking-wider uppercase" placeholder="LEISMO123456" maxlength="12">
                                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                    üé´
                                </div>
                            </div>
                            <button onclick="processCouponCode()" class="w-full brand-bg text-white py-3 rounded-lg hover:opacity-90 font-semibold">
                                üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <h5 class="font-semibold text-blue-800 mb-2">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h5>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ ‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "LEISMO"</li>
                                <li>‚Ä¢ ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6 ‡∏ï‡∏±‡∏ß</li>
                                <li>‚Ä¢ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: LEISMO123ABC</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div id="coupon-verification-result" class="hidden mt-8">
                    <!-- Results will show here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="coupon-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl my-8 max-h-screen overflow-y-auto">
            <div class="p-6 border-b text-center sticky top-0 bg-white rounded-t-2xl">
                <div class="text-4xl mb-2">üéâ</div>
                <h2 class="text-2xl font-bold brand-color">‡πÅ‡∏•‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                <p class="text-gray-600 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
            </div>
            
            <div class="p-6">
                <div class="coupon-card rounded-2xl p-6 text-white text-center mb-6 shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <img src="https://i.ibb.co/ds77x4rr/Leismo-Primarylogo-SItypo.png" alt="Leismo" class="h-8 w-auto">
                        <div class="text-right">
                            <div class="text-2xl font-bold" id="coupon-display-value">‡∏ø100</div>
                            <div class="text-sm opacity-90">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</div>
                        </div>
                    </div>
                    
                    <div class="border-2 border-white border-dashed rounded-lg p-4 mb-4">
                        <div class="text-lg font-semibold mb-2" id="coupon-display-name">‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 100‡∏ø</div>
                        <div class="text-xl font-mono tracking-wider font-bold select-all cursor-pointer" id="coupon-display-code" onclick="copyCouponCode()">LEISMO123456</div>
                        <div class="text-xs opacity-75 mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</div>
                    </div>
                    
                    <div class="flex justify-between text-sm opacity-90">
                        <span>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: <span id="coupon-created-date"></span></span>
                        <span>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span id="coupon-expiry-date"></span></span>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
                    <ol class="text-sm text-blue-700 space-y-1">
                        <li>1. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</li>
                        <li>2. ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</li>
                        <li>3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
                        <li>4. ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏≤‡∏á Line</li>
                    </ol>
                </div>

                <div class="bg-orange-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-orange-800 mb-2">‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h4>
                    <ul class="text-sm text-orange-700 space-y-1">
                        <li>‚Ä¢ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 7 ‡∏ß‡∏±‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏•‡∏Å</li>
                        <li>‚Ä¢ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</li>
                        <li>‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á Line ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á Line ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</li>
                    </ul>
                </div>
            </div>

            <div class="p-6 border-t bg-gray-50 flex gap-3 sticky bottom-0 rounded-b-2xl">
                <button onclick="copyCouponCode()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                    üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™
                </button>
                <button onclick="downloadCoupon()" class="flex-1 bg-purple-500 text-white py-3 rounded-lg font-semibold hover:bg-purple-600 transition-colors">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ
                </button>
                <button onclick="openLineChat()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                    üí¨ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                </button>
                <button onclick="closeCouponModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                    ‚úï ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        // Firebase Configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBXGkArdsTGXW58iqIas3c9dodTWv0hVuE",
            authDomain: "leismo-website-8f6b0.firebaseapp.com",
            projectId: "leismo-website-8f6b0",
            storageBucket: "leismo-website-8f6b0.firebasestorage.app",
            messagingSenderId: "1085891529571",
            appId: "1:1085891529571:web:9125f49c54ea1de9b96156",
            measurementId: "G-FZQ92YJ9ZN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firebaseLibs = {
            collection, doc, setDoc, getDoc, getDocs, updateDoc, query, where,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
        };

        // Global Variables
        window.currentUser = null;
        window.isLoggedIn = false;
        window.currentCoupon = null;

        // Mock data
        const rewards = [
            { id: 1, name: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 100‡∏ø', points: 500, type: 'coupon', value: 100, description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤' },
            { id: 2, name: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 250‡∏ø', points: 1000, type: 'coupon', value: 250, description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô ‡∏¢‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏î 250 ‡∏ö‡∏≤‡∏ó' },
            { id: 3, name: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 500‡∏ø', points: 2000, type: 'coupon', value: 500, description: '‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 2,000 ‡∏ö‡∏≤‡∏ó‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ' },
            { id: 4, name: '‡∏ü‡∏£‡∏µ‡∏™‡πà‡∏á (‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 50‡∏ø)', points: 300, type: 'coupon', value: 50, description: '‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®' },
            { id: 5, name: '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 15%', points: 1500, type: 'percent', value: 15, maxDiscount: 300, description: '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 15% ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 300 ‡∏ö‡∏≤‡∏ó' }
        ];

        // Initialize Admin User
        async function initializeAdminUser() {
            try {
                const { doc, getDoc, setDoc } = window.firebaseLibs;
                const adminRef = doc(window.db, 'users', 'admin_001');
                const adminSnap = await getDoc(adminRef);
                
                if (!adminSnap.exists()) {
                    const adminUser = {
                        uid: 'admin_001',
                        name: 'Admin Leismo',
                        email: 'admin@leismo.com',
                        points: 99999,
                        tier: 'Platinum',
                        isAdmin: true,
                        coupons: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    await setDoc(adminRef, adminUser);
                    console.log('Admin user initialized');
                }
            } catch (error) {
                console.error('Error initializing admin:', error);
            }
        }

        // Utility Functions
        function generateCouponCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'LEISMO';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function formatThaiDate(date) {
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Authentication Functions
        window.handleLogin = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const submitBtn = document.getElementById('login-submit');

            if (!email || !password) {
                showError('login-error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                return;
            }

            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            submitBtn.disabled = true;

            try {
                const { signInWithEmailAndPassword, doc, getDoc } = window.firebaseLibs;
                
                // Check if admin login
                if (email === 'admin@leismo.com' && password === 'admin123') {
                    // Load admin user from Firestore
                    const adminRef = doc(window.db, 'users', 'admin_001');
                    const adminSnap = await getDoc(adminRef);
                    
                    if (adminSnap.exists()) {
                        window.currentUser = adminSnap.data();
                        window.isLoggedIn = true;
                        updateAuthUI();
                        hideError('login-error');
                        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                        showPage('home');
                    } else {
                        throw new Error('Admin user not found');
                    }
                } else {
                    // Regular user login with Firebase Auth
                    const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
                    const user = userCredential.user;
                    
                    // Load user data from Firestore
                    const userRef = doc(window.db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        window.currentUser = userSnap.data();
                        window.isLoggedIn = true;
                        updateAuthUI();
                        hideError('login-error');
                        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                        showPage('home');
                    } else {
                        throw new Error('User data not found');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = '‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á';
                }
                
                showError('login-error', errorMessage);
            } finally {
                submitBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                submitBtn.disabled = false;
            }
        };

        window.handleRegister = async function(event) {
            event.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const birthDate = document.getElementById('register-birthdate').value;
            const submitBtn = document.getElementById('register-submit');

            if (!name || !email || !password || !birthDate) {
                showError('register-error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            if (password.length < 6) {
                showError('register-error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }

            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£...';
            submitBtn.disabled = true;

            try {
                const { createUserWithEmailAndPassword, doc, setDoc } = window.firebaseLibs;
                
                // Create user with Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                // Create user document in Firestore
                const userData = {
                    uid: user.uid,
                    name: name,
                    email: email,
                    birthDate: birthDate,
                    points: 100,
                    tier: 'Bronze',
                    coupons: [],
                    isAdmin: false,
                    createdAt: new Date().toISOString()
                };

                await setDoc(doc(window.db, 'users', user.uid), userData);

                window.currentUser = userData;
                window.isLoggedIn = true;
                updateAuthUI();
                hideError('register-error');
                
                alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Leismo\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö 100 ‡πÅ‡∏ï‡πâ‡∏°');
                showPage('home');
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏∑‡πà‡∏ô';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ';
                }
                
                showError('register-error', errorMessage);
            } finally {
                submitBtn.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                submitBtn.disabled = false;
            }
        };

        window.logout = async function() {
            try {
                const { signOut } = window.firebaseLibs;
                
                if (window.currentUser && !window.currentUser.isAdmin) {
                    await signOut(window.auth);
                }
                
                window.currentUser = null;
                window.isLoggedIn = false;
                updateAuthUI();
                showPage('home');
                alert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('Logout error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');
            }
        };

        // Listen for auth state changes
        window.firebaseLibs.onAuthStateChanged(window.auth, async (user) => {
            if (user && user.email !== 'admin@leismo.com') {
                try {
                    const { doc, getDoc } = window.firebaseLibs;
                    // Load user data from Firestore
                    const userRef = doc(window.db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        window.currentUser = userSnap.data();
                        window.isLoggedIn = true;
                        updateAuthUI();
                        console.log('User auto-logged in:', window.currentUser.name);
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            } else if (!user) {
                if (window.currentUser && !window.currentUser.isAdmin) {
                    window.currentUser = null;
                    window.isLoggedIn = false;
                    updateAuthUI();
                }
            }
        });

        // Navigation
        window.showPage = function(pageName) {
            const pages = ['home', 'login', 'register', 'loyalty', 'admin', 'scanner'];
            pages.forEach(page => {
                const pageElement = document.getElementById(`page-${page}`);
                if (pageElement) {
                    pageElement.classList.add('hidden');
                }
            });

            const targetPage = document.getElementById(`page-${pageName}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            updateNavigation(pageName);

            if (pageName === 'loyalty') {
                if (!window.isLoggedIn) {
                    showPage('login');
                    return;
                }
                updateLoyaltyPage();
            } else if (pageName === 'admin') {
                if (!window.isLoggedIn || !window.currentUser?.isAdmin) {
                    alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ\n‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    showPage('home');
                    return;
                }
                loadAdminData();
            } else if (pageName === 'scanner') {
                if (!window.isLoggedIn || !window.currentUser?.isAdmin) {
                    alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ\n‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    showPage('home');
                    return;
                }
            }
        };

        function updateNavigation(currentPage) {
            const navItems = ['nav-home', 'nav-loyalty', 'nav-admin', 'nav-scanner'];
            navItems.forEach(navId => {
                const nav = document.getElementById(navId);
                if (nav) {
                    nav.style.color = '#6B7280';
                }
            });

            const currentNav = document.getElementById(`nav-${currentPage}`);
            if (currentNav) {
                currentNav.style.color = '#B19D87';
            }
        }

        function updateAuthUI() {
            const authButtons = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');
            const navLoyalty = document.getElementById('nav-loyalty');
            const navAdmin = document.getElementById('nav-admin');
            const navScanner = document.getElementById('nav-scanner');
            const homeAuthButtons = document.getElementById('home-auth-buttons');
            const homeLoyaltyButton = document.getElementById('home-loyalty-button');

            if (window.isLoggedIn && window.currentUser) {
                authButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                navLoyalty.classList.remove('hidden');
                
                if (window.currentUser.isAdmin) {
                    navAdmin.classList.remove('hidden');
                    navScanner.classList.remove('hidden');
                } else {
                    navAdmin.classList.add('hidden');
                    navScanner.classList.add('hidden');
                }
                
                document.getElementById('user-name').textContent = window.currentUser.name;
                document.getElementById('user-points').textContent = window.currentUser.points?.toLocaleString() || '0';

                homeAuthButtons.classList.add('hidden');
                homeLoyaltyButton.classList.remove('hidden');
            } else {
                authButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
                navLoyalty.classList.add('hidden');
                navAdmin.classList.add('hidden');
                navScanner.classList.add('hidden');

                homeAuthButtons.classList.remove('hidden');
                homeLoyaltyButton.classList.add('hidden');
            }
        }

        // Loyalty Functions
        window.showLoyaltyTab = function(tabName) {
            const contents = document.querySelectorAll('.loyalty-content');
            contents.forEach(content => content.classList.add('hidden'));

            document.getElementById(`loyalty-${tabName}`).classList.remove('hidden');

            const tabs = document.querySelectorAll('.loyalty-tab');
            tabs.forEach(tab => {
                tab.style.color = '#6B7280';
                tab.style.borderColor = 'transparent';
                tab.classList.remove('border-b-2');
            });

            event.target.style.color = '#B19D87';
            event.target.style.borderColor = '#B19D87';
            event.target.classList.add('border-b-2');

            if (tabName === 'rewards') {
                loadRewards();
            } else if (tabName === 'coupons') {
                loadCoupons();
            }
        };

        // Member Card Functions
        const tierData = {
            bronze: {
                name: 'Bronze',
                icon: 'ü•â',
                bgGradient: 'linear-gradient(135deg, #526170 0%, #3a4651 100%)',
                textColor: '#CFDAE3',
                benefits: [
                    '‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: 0-5,000‡∏ø',
                    '‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: 5%',
                    '‚Ä¢ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©: 1/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                    '‚Ä¢ ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°: 1‡∏ø = 1 ‡πÅ‡∏ï‡πâ‡∏°'
                ]
            },
            silver: {
                name: 'Silver',
                icon: 'ü•à',
                bgGradient: 'linear-gradient(135deg, #F2EDE5 0%, #e8ddd0 100%)',
                textColor: '#B19D87',
                benefits: [
                    '‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: 5,001-15,000‡∏ø',
                    '‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: 10%',
                    '‚Ä¢ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©: 2/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                    '‚Ä¢ ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°: 1‡∏ø = 1.5 ‡πÅ‡∏ï‡πâ‡∏°'
                ]
            },
            gold: {
                name: 'Gold',
                icon: 'ü•á',
                bgGradient: 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)',
                textColor: '#8B4513',
                benefits: [
                    '‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: 15,001-50,000‡∏ø',
                    '‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: 15%',
                    '‚Ä¢ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©: 3/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                    '‚Ä¢ ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°: 1‡∏ø = 2 ‡πÅ‡∏ï‡πâ‡∏°'
                ]
            },
            platinum: {
                name: 'Platinum',
                icon: 'üíé',
                bgGradient: 'linear-gradient(135deg, #E5E4E2 0%, #C0C0C0 100%)',
                textColor: '#2F4F4F',
                benefits: [
                    '‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: 50,001‡∏ø+',
                    '‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: 20%',
                    '‚Ä¢ ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©: 5/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                    '‚Ä¢ ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°: 1‡∏ø = 3 ‡πÅ‡∏ï‡πâ‡∏°'
                ]
            }
        };

        const tierOrder = ['bronze', 'silver', 'gold', 'platinum'];
        let currentTierIndex = 0;

        window.showTierCard = function(tier) {
            const card = document.getElementById('member-card');
            const data = tierData[tier];
            
            if (!data) return;
            
            // Update current tier index
            currentTierIndex = tierOrder.indexOf(tier);
            
            // Add flip animation
            card.classList.add('card-flip');
            
            // Update card after half animation
            setTimeout(() => {
                // Update card appearance
                card.style.background = data.bgGradient;
                card.style.color = data.textColor;
                
                // Update card content (‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
                document.getElementById('card-tier-icon').textContent = data.icon;
                document.getElementById('card-tier-name').textContent = data.name;
                
                // Update tier info
                const tierInfo = document.getElementById('tier-info');
                tierInfo.innerHTML = data.benefits.map(benefit => `<p>${benefit}</p>`).join('');
                
                // Update tier title
                document.getElementById('current-tier-title').textContent = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${data.name}`;
            }, 300);
            
            // Remove animation class
            setTimeout(() => {
                card.classList.remove('card-flip');
            }, 600);
            
            // Update dots
            updateTierDots(tier);
        };

        function updateTierDots(activeTier) {
            document.querySelectorAll('.tier-dot').forEach(dot => {
                dot.classList.remove('active');
                dot.style.backgroundColor = '#D1D5DB'; // Gray default
            });
            
            const activeDot = document.getElementById(`dot-${activeTier}`);
            if (activeDot) {
                activeDot.classList.add('active');
            }
        }

        window.nextTier = function() {
            const nextIndex = (currentTierIndex + 1) % tierOrder.length;
            const nextTier = tierOrder[nextIndex];
            showTierCard(nextTier);
        };

        window.previousTier = function() {
            const prevIndex = (currentTierIndex - 1 + tierOrder.length) % tierOrder.length;
            const prevTier = tierOrder[prevIndex];
            showTierCard(prevTier);
        };

        function updateLoyaltyPage() {
            if (!window.currentUser) return;

            // Update card with user data
            document.getElementById('loyalty-user-name').textContent = window.currentUser.name;
            document.getElementById('card-member-name').textContent = window.currentUser.name;
            document.getElementById('card-member-email').textContent = window.currentUser.email;
            document.getElementById('card-points').textContent = (window.currentUser.points || 0).toLocaleString();
            
            // Format member since date
            if (window.currentUser.createdAt) {
                const memberSince = new Date(window.currentUser.createdAt).getFullYear();
                document.getElementById('card-member-since').textContent = memberSince;
            }

            // Show user's actual tier
            const userTier = (window.currentUser.tier || 'Bronze').toLowerCase();
            showTierCard(userTier);

            // Update dashboard stats
            document.getElementById('dashboard-tier').textContent = window.currentUser.tier;
            document.getElementById('dashboard-points').textContent = window.currentUser.points?.toLocaleString() || '0';
            document.getElementById('dashboard-coupons').textContent = (window.currentUser.coupons || []).filter(c => !c.used).length;
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('page-loyalty').classList.contains('hidden')) return;
            
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousTier();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextTier();
            }
        });

        function loadRewards() {
            const container = document.getElementById('rewards-container');
            container.innerHTML = '';

            rewards.forEach(reward => {
                const canRedeem = window.currentUser && window.currentUser.points >= reward.points;
                const rewardDiv = document.createElement('div');
                rewardDiv.className = 'border rounded-lg p-6 text-center hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1';
                rewardDiv.style.borderColor = '#DACFBD';

                rewardDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="text-6xl mb-2">üéÅ</div>
                        <div class="text-2xl font-bold mb-1" style="color: #B19D87;">
                            ${reward.type === 'coupon' ? `‡∏ø${reward.value}` : `${reward.value}%`}
                        </div>
                    </div>
                    <h4 class="font-semibold mb-2" style="color: #B19D87;">${reward.name}</h4>
                    <p class="text-sm text-gray-600 mb-3">${reward.description}</p>
                    <p class="text-2xl font-bold mb-4" style="color: #B19D87;">
                        ${reward.points.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°
                    </p>
                    <button onclick="redeemReward(${reward.id})" 
                            ${!canRedeem ? 'disabled' : ''} 
                            class="w-full py-3 rounded-lg font-semibold transition-all duration-200 ${canRedeem ? 'text-white hover:opacity-90 hover:shadow-lg transform hover:scale-105' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
                            ${canRedeem ? 'style="background-color: #B19D87;"' : ''}>
                        ${canRedeem ? 'üéØ ‡πÅ‡∏•‡∏Å‡πÄ‡∏•‡∏¢' : '‚ùå ‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠'}
                    </button>
                `;

                container.appendChild(rewardDiv);
            });
        }

        function loadCoupons() {
            const container = document.getElementById('coupons-container');
            const userCoupons = window.currentUser?.coupons || [];

            if (userCoupons.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-8xl mb-4">üéÅ</div>
                        <p class="text-gray-500 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                        <p class="text-gray-400">‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</p>
                        <button onclick="showLoyaltyTab('rewards')" class="mt-4 text-white px-6 py-2 rounded-lg hover:opacity-90" style="background-color: #B19D87;">
                            ‡πÑ‡∏õ‡πÅ‡∏•‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>';
            const grid = container.querySelector('.grid');

            userCoupons.forEach((coupon) => {
                const isExpired = new Date() > new Date(coupon.expiryTimestamp || coupon.expiryDate);
                const couponDiv = document.createElement('div');
                couponDiv.className = `border rounded-lg p-6 transition-all duration-200 hover:shadow-lg cursor-pointer ${
                    coupon.used ? 'opacity-50 bg-gray-50 border-gray-300' : 
                    isExpired ? 'opacity-60 bg-red-50 border-red-200' :
                    'bg-white border-dashed hover:scale-105'
                }`;
                couponDiv.style.borderColor = coupon.used ? '#ccc' : isExpired ? '#fecaca' : '#B19D87';

                couponDiv.onclick = () => {
                    if (!coupon.used && !isExpired) {
                        window.currentCoupon = coupon;
                        showCouponModal(coupon);
                    }
                };

                const statusIcon = coupon.used ? '‚úÖ' : isExpired ? '‚è∞' : 'üé´';
                const statusText = coupon.used ? '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : isExpired ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ';
                const statusColor = coupon.used ? 'bg-gray-100 text-gray-600' : 
                                   isExpired ? 'bg-red-100 text-red-600' : 
                                   'bg-green-100 text-green-600';

                couponDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1" style="color: #B19D87;">${coupon.name}</h4>
                            <p class="text-sm text-gray-600 mb-2">${coupon.description || '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≤‡∏Å Leismo'}</p>
                            <p class="text-xs text-gray-500">‡πÇ‡∏Ñ‡πâ‡∏î: <span class="font-mono font-semibold">${coupon.code}</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold" style="color: #B19D87;">
                                ${coupon.type === 'coupon' ? `‡∏ø${coupon.value}` : `${coupon.value}%`}
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm text-gray-600">
                            <p>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${coupon.createdDate}</p>
                            <p>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${coupon.expiryDate}</p>
                        </div>
                        <div class="text-center py-2 px-4 rounded-full text-sm font-semibold ${statusColor}">
                            ${statusIcon} ${statusText}
                        </div>
                    </div>
                    ${!coupon.used && !isExpired ? `
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800 mb-2">üí° <strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</strong></p>
                            <p class="text-xs text-blue-600">‚Ä¢ ‡∏î‡∏π QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
                            <p class="text-xs text-blue-600">‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                        </div>
                    ` : ''}
                `;

                grid.appendChild(couponDiv);
            });
        }

        // Forgot Password Functions
        window.showForgotPasswordModal = function() {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Clear form
            document.getElementById('forgot-email').value = '';
            hideError('forgot-error');
            hideError('forgot-success');
        };

        window.closeForgotPasswordModal = function() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        };

        // Close modal when clicking outside
        document.getElementById('forgot-password-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeForgotPasswordModal();
            }
        });

        window.handleForgotPassword = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgot-email').value.trim();
            const submitBtn = document.getElementById('forgot-submit');
            
            if (!email) {
                showError('forgot-error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•');
                return;
            }

            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            submitBtn.disabled = true;
            hideError('forgot-error');
            hideError('forgot-success');

            try {
                // Import sendPasswordResetEmail
                const { sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
                
                await sendPasswordResetEmail(window.auth, email);
                
                // Show success message
                document.getElementById('forgot-success').textContent = `‚úÖ ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${email} ‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Spam)`;
                document.getElementById('forgot-success').classList.remove('hidden');
                
                // Clear form
                document.getElementById('forgot-email').value = '';
                
            } catch (error) {
                console.error('Password reset error:', error);
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á';
                }
                
                showError('forgot-error', errorMessage);
            } finally {
                submitBtn.textContent = 'üì® ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
                submitBtn.disabled = false;
            }
        };

        // User Details Functions
        let currentSelectedUser = null;

        window.showUserDetails = function(user) {
            // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á object ‡πÅ‡∏•‡∏∞ string
            if (typeof user === 'string') {
                try {
                    user = JSON.parse(user);
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                    return;
                }
            }
            
            currentSelectedUser = user;
            console.log('Showing user details for:', user.name);
            
            // Fill personal info
            document.getElementById('user-detail-name').textContent = user.name || '-';
            document.getElementById('user-detail-email').textContent = user.email || '-';
            document.getElementById('user-detail-birthdate').textContent = user.birthDate ? new Date(user.birthDate).toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : '-';
            document.getElementById('user-detail-uid').textContent = user.uid || '-';
            document.getElementById('user-detail-created').textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '-';
            document.getElementById('user-detail-tier').textContent = user.tier || 'Bronze';
            
            // Fill points
            document.getElementById('user-detail-points').textContent = (user.points || 0).toLocaleString();
            
            // Fill coupons
            const userCoupons = user.coupons || [];
            document.getElementById('user-detail-coupon-count').textContent = userCoupons.length;
            
            const couponsContainer = document.getElementById('user-detail-coupons');
            
            if (userCoupons.length === 0) {
                couponsContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üì≠</div>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                    </div>
                `;
            } else {
                couponsContainer.innerHTML = '<div class="space-y-4"></div>';
                const couponsGrid = couponsContainer.querySelector('.space-y-4');
                
                userCoupons.forEach((coupon, index) => {
                    const isExpired = new Date() > new Date(coupon.expiryTimestamp || coupon.expiryDate);
                    const statusIcon = coupon.used ? '‚úÖ ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : isExpired ? '‚è∞ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' : 'üé´ ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ';
                    const statusColor = coupon.used ? 'bg-gray-100 text-gray-600' : 
                                       isExpired ? 'bg-red-100 text-red-600' : 
                                       'bg-green-100 text-green-600';
                    
                    const couponDiv = document.createElement('div');
                    couponDiv.className = 'border rounded-lg p-4 hover:bg-gray-50';
                    couponDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="font-semibold text-lg">#${index + 1}</span>
                                    <span class="font-mono text-sm bg-gray-200 px-2 py-1 rounded">${coupon.code}</span>
                                </div>
                                <h4 class="font-semibold brand-color">${coupon.name}</h4>
                                <p class="text-sm text-gray-600 mb-2">${coupon.description || '-'}</p>
                                <div class="text-xs text-gray-500 space-y-1">
                                    <p>üí∞ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: ${coupon.type === 'coupon' ? `‡∏ø${coupon.value}` : `${coupon.value}%`}</p>
                                    <p>üìÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${coupon.createdDate}</p>
                                    <p>‚è∞ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${coupon.expiryDate}</p>
                                    ${coupon.used ? `<p>‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${coupon.usedDate || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold brand-color mb-2">
                                    ${coupon.type === 'coupon' ? `‡∏ø${coupon.value}` : `${coupon.value}%`}
                                </div>
                                <div class="text-center py-1 px-3 rounded-full text-xs font-semibold ${statusColor}">
                                    ${statusIcon}
                                </div>
                            </div>
                        </div>
                    `;
                    couponsGrid.appendChild(couponDiv);
                });
            }
            
            // Show modal
            document.body.style.overflow = 'hidden';
            document.getElementById('user-details-modal').classList.remove('hidden');
        };

        window.closeUserDetailsModal = function() {
            document.getElementById('user-details-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentSelectedUser = null;
        };

        // Close modal when clicking outside
        document.getElementById('user-details-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserDetailsModal();
            }
        });

        window.editUserPoints = function() {
            if (!currentSelectedUser) return;
            
            const currentPoints = currentSelectedUser.points || 0;
            const newPoints = prompt(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á ${currentSelectedUser.name}\n\n‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${currentPoints.toLocaleString()}\n‡πÉ‡∏™‡πà‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà:`, currentPoints);
            
            if (newPoints === null) return; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            
            const pointsNumber = parseInt(newPoints);
            if (isNaN(pointsNumber) || pointsNumber < 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0)');
                return;
            }
            
            updateUserPoints(currentSelectedUser.uid, pointsNumber);
        };

        window.resetUserPassword = async function() {
            if (!currentSelectedUser) return;
            
            const confirmed = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ${currentSelectedUser.name}?\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${currentSelectedUser.email}`);
            
            if (!confirmed) return;
            
            try {
                // Import sendPasswordResetEmail
                const { sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
                
                await sendPasswordResetEmail(window.auth, currentSelectedUser.email);
                
                alert(`‚úÖ ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà: ${currentSelectedUser.email}\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Spam)`);
                
            } catch (error) {
                console.error('Admin password reset error:', error);
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á';
                }
                
                alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î\n${errorMessage}`);
            }
        };

        async function updateUserPoints(userId, newPoints) {
            try {
                const { doc, updateDoc } = window.firebaseLibs;
                const userRef = doc(window.db, 'users', userId);
                
                await updateDoc(userRef, {
                    points: newPoints
                });
                
                // Update current user data if it's the same user
                if (currentSelectedUser) {
                    currentSelectedUser.points = newPoints;
                    document.getElementById('user-detail-points').textContent = newPoints.toLocaleString();
                }
                
                alert(`‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà: ${newPoints.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°`);
                
                // Refresh admin data
                loadAdminData();
                
            } catch (error) {
                console.error('Error updating points:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ï‡πâ‡∏°');
            }
        }

        // Admin Functions
        async function loadAdminData() {
            if (!window.currentUser?.isAdmin) return;

            try {
                const { collection, getDocs } = window.firebaseLibs;
                const usersCollection = collection(window.db, 'users');
                const querySnapshot = await getDocs(usersCollection);
                
                let totalUsers = 0;
                let totalPoints = 0;
                let totalCoupons = 0;
                let totalValue = 0;
                const usersList = [];

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (!userData.isAdmin) {
                        totalUsers++;
                        totalPoints += userData.points || 0;
                        
                        const userCoupons = userData.coupons || [];
                        totalCoupons += userCoupons.length;
                        
                        userCoupons.forEach(coupon => {
                            if (coupon.type === 'coupon') {
                                totalValue += coupon.value;
                            }
                        });
                        
                        usersList.push(userData);
                    }
                });

                // Update admin stats
                document.getElementById('admin-total-users').textContent = totalUsers;
                document.getElementById('admin-total-points').textContent = totalPoints.toLocaleString();
                document.getElementById('admin-total-coupons').textContent = totalCoupons;
                document.getElementById('admin-total-value').textContent = totalValue.toLocaleString() + '‡∏ø';

                // Load users list
                const usersListContainer = document.getElementById('admin-users-list');
                usersListContainer.innerHTML = '';

                if (usersList.length === 0) {
                    usersListContainer.innerHTML = '<p class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>';
                    return;
                }

                usersList.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors';
                    userDiv.style.borderColor = '#DACFBD';
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                    userDiv.addEventListener('dblclick', function() {
                        console.log('Double clicked user:', user.name);
                        showUserDetails(user);
                    });
                    
                    userDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold">${user.name}</h4>
                                <p class="text-sm text-gray-600">${user.email}</p>
                                <p class="text-xs text-gray-500">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(user.createdAt).toLocaleDateString('th-TH')}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold brand-color">${user.tier}</p>
                                <p class="text-sm">${(user.points || 0).toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°</p>
                                <p class="text-xs text-gray-500">${(user.coupons || []).length} ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-blue-600 font-medium">
                            üí° ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                        </div>
                        <div class="mt-3">
                            <button onclick="showUserDetails(${JSON.stringify(user).replace(/"/g, '&quot;')})" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                                üëÄ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </button>
                        </div>
                    `;
                    usersListContainer.appendChild(userDiv);
                });

            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // Coupon Functions
        window.redeemReward = async function(rewardId) {
            if (!window.currentUser) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const reward = rewards.find(r => r.id === rewardId);
            if (!reward) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•');
                return;
            }

            if (window.currentUser.points < reward.points) {
                alert('‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ');
                return;
            }

            try {
                const { doc, updateDoc } = window.firebaseLibs;
                
                const couponCode = generateCouponCode();
                const createdDate = new Date();
                const expiryDate = new Date(createdDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                const newCoupon = {
                    id: Date.now().toString(),
                    code: couponCode,
                    name: reward.name,
                    type: reward.type,
                    value: reward.value,
                    maxDiscount: reward.maxDiscount || null,
                    description: reward.description,
                    used: false,
                    createdDate: formatThaiDate(createdDate),
                    expiryDate: formatThaiDate(expiryDate),
                    createdTimestamp: createdDate.toISOString(),
                    expiryTimestamp: expiryDate.toISOString(),
                    userId: window.currentUser.uid,
                    userName: window.currentUser.name
                };

                // Update user data
                window.currentUser.points -= reward.points;
                window.currentUser.coupons = window.currentUser.coupons || [];
                window.currentUser.coupons.push(newCoupon);

                // Update in Firestore
                const userRef = doc(window.db, 'users', window.currentUser.uid);
                await updateDoc(userRef, {
                    points: window.currentUser.points,
                    coupons: window.currentUser.coupons
                });

                window.currentCoupon = newCoupon;
                showCouponModal(newCoupon);
                updateLoyaltyPage();
                updateAuthUI();

                console.log('Coupon redeemed successfully:', newCoupon);

            } catch (error) {
                console.error('Redeem error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            }
        };

        function showCouponModal(coupon) {
            document.getElementById('coupon-display-name').textContent = coupon.name;
            document.getElementById('coupon-display-code').textContent = coupon.code;
            document.getElementById('coupon-created-date').textContent = coupon.createdDate;
            document.getElementById('coupon-expiry-date').textContent = coupon.expiryDate;
            
            const valueDisplay = document.getElementById('coupon-display-value');
            if (coupon.type === 'coupon') {
                valueDisplay.textContent = `‡∏ø${coupon.value}`;
            } else {
                valueDisplay.textContent = `${coupon.value}%`;
            }

            setTimeout(() => {
                generateQRCode(coupon);
            }, 100);

            document.getElementById('coupon-modal').classList.remove('hidden');
        }

        function generateQRCode(coupon) {
            const canvas = document.getElementById('qr-code');
            if (!canvas) return;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const verificationUrl = `${window.location.origin}${window.location.pathname}#verify-${coupon.code}`;
            
            if (typeof QRCode !== 'undefined') {
                // ‡∏•‡πâ‡∏≤‡∏á canvas ‡πÄ‡∏Å‡πà‡∏≤
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                QRCode.toCanvas(canvas, verificationUrl, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#B19D87',
                        light: '#FFFFFF'
                    },
                    errorCorrectionLevel: 'M',
                    margin: 2
                }, function(error) {
                    if (error) {
                        console.error('QR Code error:', error);
                        // Fallback: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô
                        showFallbackQR(canvas, coupon.code);
                    }
                });
            } else {
                showFallbackQR(canvas, coupon.code);
            }
        }

        function showFallbackQR(canvas, code) {
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, 200, 200);
            
            // Border
            ctx.strokeStyle = '#B19D87';
            ctx.lineWidth = 2;
            ctx.strokeRect(10, 10, 180, 180);
            
            // Text
            ctx.fillStyle = '#666';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('QR Code', 100, 80);
            ctx.font = '12px monospace';
            ctx.fillText(code, 100, 100);
            ctx.font = '10px Arial';
            ctx.fillText('‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', 100, 130);
        }

        window.closeCouponModal = function() {
            document.getElementById('coupon-modal').classList.add('hidden');
            window.currentCoupon = null;
        };

        window.openLineChat = function() {
            // ‡πÄ‡∏õ‡∏¥‡∏î Line Chat ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            window.open('https://lin.ee/EVNhIRq', '_blank');
        };

        // Copy coupon code function
        window.copyCouponCode = function() {
            const codeElement = document.getElementById('coupon-display-code-large');
            const code = codeElement.textContent;
            
            // Try to copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopy(code);
                });
            } else {
                fallbackCopy(code);
            }
        };

        function fallbackCopy(text) {
            // Fallback method for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                console.error('Could not copy text: ', err);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á');
            }
            document.body.removeChild(textArea);
        }

        function showCopySuccess() {
            const codeElement = document.getElementById('coupon-display-code-large');
            const originalText = codeElement.textContent;
            
            // Show success message
            codeElement.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
            codeElement.style.color = '#10B981';
            
            // Reset after 2 seconds
            setTimeout(() => {
                codeElement.textContent = originalText;
                codeElement.style.color = '#B19D87';
            }, 2000);
        }

        window.downloadCoupon = function() {
            // Create a temporary canvas to capture the coupon
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 600;

            // Draw coupon background
            const gradient = ctx.createLinearGradient(0, 0, 400, 600);
            gradient.addColorStop(0, '#B19D87');
            gradient.addColorStop(1, '#DACFBD');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 400, 600);

            // Add text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Leismo Coupon', 200, 50);

            // Create download link
            const link = document.createElement('a');
            link.download = `leismo-coupon-${window.currentCoupon?.code || 'download'}.png`;
            link.href = canvas.toDataURL();
            link.click();
        };

        // Scanner Tab Functions
        window.showScannerTab = function(tabName) {
            const contents = document.querySelectorAll('.scanner-content');
            contents.forEach(content => content.classList.add('hidden'));

            document.getElementById(`scanner-${tabName}`).classList.remove('hidden');

            const tabs = document.querySelectorAll('.scanner-tab');
            tabs.forEach(tab => {
                tab.style.color = '#6B7280';
                tab.style.borderColor = 'transparent';
                tab.classList.remove('border-b-2');
            });

            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.style.color = '#B19D87';
            activeTab.style.borderColor = '#B19D87';
            activeTab.classList.add('border-b-2');
        };

        // Process Coupon Code (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
        window.processCouponCode = async function() {
            const codeInput = document.getElementById('coupon-code-input').value.trim().toUpperCase();
            
            if (!codeInput) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á');
                return;
            }

            if (!codeInput.startsWith('LEISMO') || codeInput.length !== 12) {
                alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ LEISMO ‡πÅ‡∏•‡∏∞‡∏°‡∏µ 12 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }

            try {
                const { collection, getDocs } = window.firebaseLibs;
                const usersRef = collection(window.db, 'users');
                const querySnapshot = await getDocs(usersRef);
                
                let couponFound = null;
                let ownerData = null;

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userCoupons = userData.coupons || [];
                    const foundCoupon = userCoupons.find(c => c.code === codeInput);
                    
                    if (foundCoupon) {
                        couponFound = foundCoupon;
                        ownerData = userData;
                    }
                });

                if (!couponFound) {
                    showVerificationResult({
                        status: 'invalid',
                        coupon: {
                            code: codeInput,
                            name: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á',
                            type: 'unknown',
                            value: 0,
                            createdDate: '-',
                            expiryDate: '-'
                        },
                        owner: {
                            name: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                            email: '-',
                            tier: '-',
                            points: 0
                        }
                    });
                    return;
                }

                // Check if expired
                const isExpired = new Date() > new Date(couponFound.expiryTimestamp);
                
                // Determine status
                let status = 'valid';
                if (couponFound.used) {
                    status = 'used';
                } else if (isExpired) {
                    status = 'expired';
                }

                showVerificationResult({
                    status: status,
                    coupon: {
                        code: couponFound.code,
                        name: couponFound.name,
                        type: couponFound.type,
                        value: couponFound.value,
                        createdDate: couponFound.createdDate,
                        expiryDate: couponFound.expiryDate
                    },
                    owner: {
                        name: ownerData.name,
                        email: ownerData.email,
                        tier: ownerData.tier,
                        points: ownerData.points
                    }
                });

            } catch (error) {
                console.error('Code processing error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á');
            }
        };

        // Auto-format coupon code input
        document.addEventListener('DOMContentLoaded', function() {
            const codeInput = document.getElementById('coupon-code-input');
            if (codeInput) {
                codeInput.addEventListener('input', function(e) {
                    let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    if (value.length > 12) {
                        value = value.substring(0, 12);
                    }
                    e.target.value = value;
                });

                // Enter key to search
                codeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        processCouponCode();
                    }
                });
            }
        });

        // Scanner Functions
        window.processQRData = async function() {
            const qrInput = document.getElementById('qr-data-input').value.trim();
            
            if (!qrInput) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR Code');
                return;
            }

            try {
                const qrData = JSON.parse(qrInput);
                
                if (qrData.type !== 'LEISMO_COUPON') {
                    throw new Error('‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà QR Code ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á Leismo');
                }

                // Find the coupon in Firebase
                const { collection, query, where, getDocs } = window.firebaseLibs;
                const usersRef = collection(window.db, 'users');
                const q = query(usersRef, where('coupons', 'array-contains-any', [{ code: qrData.code }]));
                
                let couponFound = null;
                let ownerData = null;

                const querySnapshot = await getDocs(usersRef);
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userCoupons = userData.coupons || [];
                    const foundCoupon = userCoupons.find(c => c.code === qrData.code);
                    
                    if (foundCoupon) {
                        couponFound = foundCoupon;
                        ownerData = userData;
                    }
                });

                if (!couponFound) {
                    showVerificationResult({
                        status: 'invalid',
                        coupon: {
                            code: qrData.code,
                            name: '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö',
                            type: 'unknown',
                            value: 0,
                            createdDate: '-',
                            expiryDate: '-'
                        },
                        owner: {
                            name: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                            email: '-',
                            tier: '-',
                            points: 0
                        }
                    });
                    return;
                }

                // Check if expired
                const isExpired = new Date() > new Date(couponFound.expiryTimestamp);
                
                // Determine status
                let status = 'valid';
                if (couponFound.used) {
                    status = 'used';
                } else if (isExpired) {
                    status = 'expired';
                }

                showVerificationResult({
                    status: status,
                    coupon: {
                        code: couponFound.code,
                        name: couponFound.name,
                        type: couponFound.type,
                        value: couponFound.value,
                        createdDate: couponFound.createdDate,
                        expiryDate: couponFound.expiryDate
                    },
                    owner: {
                        name: ownerData.name,
                        email: ownerData.email,
                        tier: ownerData.tier,
                        points: ownerData.points
                    }
                });

            } catch (error) {
                console.error('QR processing error:', error);
                alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR Code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            }
        };

        function showVerificationResult(result) {
            const container = document.getElementById('coupon-verification-result');
            container.classList.remove('hidden');

            let statusColor, statusIcon, statusText;
            
            switch (result.status) {
                case 'valid':
                    statusColor = 'bg-green-50 border-green-200';
                    statusIcon = '‚úÖ';
                    statusText = '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ';
                    break;
                case 'used':
                    statusColor = 'bg-red-50 border-red-200';
                    statusIcon = '‚ùå';
                    statusText = '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß';
                    break;
                case 'expired':
                    statusColor = 'bg-orange-50 border-orange-200';
                    statusIcon = '‚è∞';
                    statusText = '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
                    break;
                case 'invalid':
                    statusColor = 'bg-red-50 border-red-200';
                    statusIcon = 'üö´';
                    statusText = '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    break;
            }

            const coupon = result.coupon;
            const owner = result.owner;
            const canUse = result.status === 'valid';

            container.innerHTML = `
                <div class="border-2 rounded-lg p-6 ${statusColor}">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2">${statusIcon}</div>
                        <h3 class="text-xl font-semibold">${statusText}</h3>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${coupon.code}</p>
                                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${coupon.name}</p>
                                <p><strong>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</strong> ${coupon.type === 'coupon' ? `‡∏ø${coupon.value}` : coupon.type === 'percent' ? `${coupon.value}%` : '-'}</p>
                                <p><strong>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</strong> ${coupon.createdDate}</p>
                                <p><strong>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${coupon.expiryDate}</p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${owner.name}</p>
                                <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${owner.email}</p>
                                <p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</strong> ${owner.tier}</p>
                                <p><strong>‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> ${owner.points?.toLocaleString() || '0'} ‡πÅ‡∏ï‡πâ‡∏°</p>
                            </div>
                        </div>
                    </div>

                    ${canUse ? `
                        <div class="mt-6 text-center">
                            <button onclick="useCoupon('${coupon.code}')" class="bg-green-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-600">
                                ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        window.useCoupon = async function(couponCode) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ${couponCode}?`)) {
                return;
            }

            try {
                const { collection, getDocs, doc, updateDoc } = window.firebaseLibs;
                const usersRef = collection(window.db, 'users');
                const querySnapshot = await getDocs(usersRef);
                
                let foundUser = null;
                let couponIndex = -1;

                querySnapshot.forEach((docSnapshot) => {
                    const userData = docSnapshot.data();
                    const userCoupons = userData.coupons || [];
                    const index = userCoupons.findIndex(c => c.code === couponCode);
                    
                    if (index !== -1) {
                        foundUser = { id: docSnapshot.id, data: userData };
                        couponIndex = index;
                    }
                });

                if (foundUser && couponIndex !== -1) {
                    // Mark coupon as used
                    foundUser.data.coupons[couponIndex].used = true;
                    foundUser.data.coupons[couponIndex].usedDate = formatThaiDate(new Date());
                    foundUser.data.coupons[couponIndex].usedTimestamp = new Date().toISOString();

                    // Update in Firestore
                    const userRef = doc(window.db, 'users', foundUser.id);
                    await updateDoc(userRef, {
                        coupons: foundUser.data.coupons
                    });

                    alert('‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    
                    // Refresh the verification result
                    document.getElementById('qr-data-input').value = '';
                    document.getElementById('coupon-verification-result').classList.add('hidden');
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
                }

            } catch (error) {
                console.error('Error using coupon:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á');
            }
        };

        // Error Functions
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        }

        function hideError(elementId) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
        }

        // Admin verification for coupon checking
        window.verifyAdminAccess = function(event) {
            event.preventDefault();
            
            const password = document.getElementById('admin-verify-password').value;
            const submitBtn = document.getElementById('admin-verify-submit');
            
            if (!password) {
                showError('admin-verify-error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                return;
            }
            
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            submitBtn.disabled = true;
            
            // Check admin password
            if (password === 'admin123') {
                hideError('admin-verify-error');
                document.getElementById('admin-auth-section').classList.add('hidden');
                document.getElementById('coupon-check-section').classList.remove('hidden');
                
                // Process the coupon code from URL
                const hash = window.location.hash;
                if (hash.startsWith('#verify-')) {
                    const couponCode = hash.replace('#verify-', '');
                    document.getElementById('checking-coupon-code').textContent = couponCode;
                    checkCouponStatus(couponCode);
                }
            } else {
                showError('admin-verify-error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
            
            submitBtn.textContent = 'üîì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            submitBtn.disabled = false;
        };

        // Check coupon status for verification page
        async function checkCouponStatus(couponCode) {
            const resultContainer = document.getElementById('coupon-status-result');
            resultContainer.innerHTML = '<div class="text-center py-8"><div class="animate-spin text-4xl">‚è≥</div><p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</p></div>';
            
            try {
                const { collection, getDocs } = window.firebaseLibs;
                const usersRef = collection(window.db, 'users');
                const querySnapshot = await getDocs(usersRef);
                
                let couponFound = null;
                let ownerData = null;

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userCoupons = userData.coupons || [];
                    const foundCoupon = userCoupons.find(c => c.code === couponCode);
                    
                    if (foundCoupon) {
                        couponFound = foundCoupon;
                        ownerData = userData;
                    }
                });

                if (!couponFound) {
                    showCouponResult({
                        status: 'invalid',
                        coupon: { code: couponCode, name: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á' },
                        owner: { name: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' }
                    });
                    return;
                }

                // Check status
                const isExpired = new Date() > new Date(couponFound.expiryTimestamp);
                let status = 'valid';
                if (couponFound.used) {
                    status = 'used';
                } else if (isExpired) {
                    status = 'expired';
                }

                showCouponResult({
                    status: status,
                    coupon: couponFound,
                    owner: ownerData
                });

            } catch (error) {
                console.error('Error checking coupon:', error);
                resultContainer.innerHTML = '<div class="text-center py-8 text-red-600"><div class="text-4xl">‚ùå</div><p class="mt-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p></div>';
            }
        }

        function showCouponResult(result) {
            const container = document.getElementById('coupon-status-result');
            
            let statusColor, statusIcon, statusText, statusBg;
            
            switch (result.status) {
                case 'valid':
                    statusColor = 'text-green-800';
                    statusBg = 'bg-green-50 border-green-200';
                    statusIcon = '‚úÖ';
                    statusText = '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ';
                    break;
                case 'used':
                    statusColor = 'text-red-800';
                    statusBg = 'bg-red-50 border-red-200';
                    statusIcon = '‚ùå';
                    statusText = '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß';
                    break;
                case 'expired':
                    statusColor = 'text-orange-800';
                    statusBg = 'bg-orange-50 border-orange-200';
                    statusIcon = '‚è∞';
                    statusText = '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
                    break;
                default:
                    statusColor = 'text-red-800';
                    statusBg = 'bg-red-50 border-red-200';
                    statusIcon = 'üö´';
                    statusText = '‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            }

            const canUse = result.status === 'valid';
            const coupon = result.coupon;
            const owner = result.owner;

            container.innerHTML = `
                <div class="border-2 rounded-lg p-6 ${statusBg}">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">${statusIcon}</div>
                        <h2 class="text-2xl font-bold ${statusColor}">${statusText}</h2>
                    </div>

                    ${coupon.name !== '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á' ? `
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="space-y-3">
                                <h3 class="text-lg font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</h3>
                                <div class="space-y-2 text-sm">
                                    <p><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${coupon.code}</p>
                                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${coupon.name}</p>
                                    <p><strong>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</strong> ${coupon.type === 'coupon' ? `‡∏ø${coupon.value}` : `${coupon.value}%`}</p>
                                    <p><strong>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</strong> ${coupon.createdDate}</p>
                                    <p><strong>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${coupon.expiryDate}</p>
                                    ${coupon.used ? `<p><strong>‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${coupon.usedDate || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>` : ''}
                                </div>
                            </div>

                            <div class="space-y-3">
                                <h3 class="text-lg font-semibold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                                <div class="space-y-2 text-sm">
                                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${owner.name}</p>
                                    <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${owner.email}</p>
                                    <p><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</strong> ${owner.tier}</p>
                                    <p><strong>‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> ${owner.points?.toLocaleString() || '0'} ‡πÅ‡∏ï‡πâ‡∏°</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${canUse ? `
                        <div class="text-center">
                            <button onclick="useCouponFromVerify('${coupon.code}')" class="bg-green-500 text-white px-8 py-4 rounded-lg font-semibold hover:bg-green-600 text-lg">
                                ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
                            </button>
                        </div>
                    ` : ''}
                    
                    <div class="mt-6 text-center">
                        <button onclick="goBackToHome()" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600">
                            üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                        </button>
                    </div>
                </div>
            `;
        }

        // Use coupon from verification page
        window.useCouponFromVerify = async function(couponCode) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ${couponCode}?`)) {
                return;
            }

            try {
                const { collection, getDocs, doc, updateDoc } = window.firebaseLibs;
                const usersRef = collection(window.db, 'users');
                const querySnapshot = await getDocs(usersRef);
                
                let foundUser = null;
                let couponIndex = -1;

                querySnapshot.forEach((docSnapshot) => {
                    const userData = docSnapshot.data();
                    const userCoupons = userData.coupons || [];
                    const index = userCoupons.findIndex(c => c.code === couponCode);
                    
                    if (index !== -1) {
                        foundUser = { id: docSnapshot.id, data: userData };
                        couponIndex = index;
                    }
                });

                if (foundUser && couponIndex !== -1) {
                    // Mark coupon as used
                    foundUser.data.coupons[couponIndex].used = true;
                    foundUser.data.coupons[couponIndex].usedDate = formatThaiDate(new Date());
                    foundUser.data.coupons[couponIndex].usedTimestamp = new Date().toISOString();

                    // Update in Firestore
                    const userRef = doc(window.db, 'users', foundUser.id);
                    await updateDoc(userRef, {
                        coupons: foundUser.data.coupons
                    });

                    alert('‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    
                    // Refresh the status
                    checkCouponStatus(couponCode);
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏');
                }

            } catch (error) {
                console.error('Error using coupon:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á');
            }
        };

        window.goBackToHome = function() {
            history.replaceState(null, null, window.location.pathname);
            showPage('home');
        };

        // Handle QR Code verification URL
        function handleVerificationUrl() {
            const hash = window.location.hash;
            if (hash.startsWith('#verify-')) {
                const couponCode = hash.replace('#verify-', '');
                
                // Go to verification page
                showPage('verify');
                
                // Reset the form
                document.getElementById('admin-auth-section').classList.remove('hidden');
                document.getElementById('coupon-check-section').classList.add('hidden');
                document.getElementById('admin-verify-password').value = '';
                hideError('admin-verify-error');
            }
        }

        // Update showPage function to handle verify page
        const originalShowPage = window.showPage;
        window.showPage = function(pageName) {
            const pages = ['home', 'login', 'register', 'loyalty', 'admin', 'scanner', 'verify'];
            pages.forEach(page => {
                const pageElement = document.getElementById(`page-${page}`);
                if (pageElement) {
                    pageElement.classList.add('hidden');
                }
            });

            const targetPage = document.getElementById(`page-${pageName}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            updateNavigation(pageName);

            if (pageName === 'loyalty') {
                if (!window.isLoggedIn) {
                    showPage('login');
                    return;
                }
                updateLoyaltyPage();
            } else if (pageName === 'admin') {
                if (!window.isLoggedIn || !window.currentUser?.isAdmin) {
                    alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ\n‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    showPage('home');
                    return;
                }
                loadAdminData();
            } else if (pageName === 'scanner') {
                if (!window.isLoggedIn || !window.currentUser?.isAdmin) {
                    alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ\n‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    showPage('home');
                    return;
                }
            }
            // Note: verify page doesn't need admin check as it has its own auth
        };

        // Listen for hash changes (when QR code is scanned)
        window.addEventListener('hashchange', handleVerificationUrl);
        
        // Check URL on page load
        document.addEventListener('DOMContentLoaded', async function() {
            showPage('home');
            await initializeAdminUser();
            handleVerificationUrl();
        });

    </script>
</body>
</html>
