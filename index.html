<script type="module">
        // Firebase Configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBXGkArdsTGXW58iqIas3c9dodTWv0hVuE",
            authDomain: "leismo-website-8f6b0.firebaseapp.com",
            projectId: "leismo-website-8f6b0",
            storageBucket: "leismo-website-8f6b0.firebasestorage.app",
            messagingSenderId: "1085891529571",
            appId: "1:1085891529571:web:9125f49c54ea1de9b96156",
            measurementId: "G-FZQ92YJ9ZN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global Variables
        window.currentUser = null;
        window.isLoggedIn = false;
        window.currentCoupon = null;

        // Mock data
        const rewards = [
            { id: 1, name: 'คูปองส่วนลด 100฿', points: 500, type: 'coupon', value: 100, description: 'ใช้กับสินค้าทุกชิ้น ยกเว้นสินค้าลดราคา' },
            { id: 2, name: 'คูปองส่วนลด 250฿', points: 1000, type: 'coupon', value: 250, description: 'ใช้กับสินค้าทุกชิ้น ยื่อสุด 250 บาท' },
            { id: 3, name: 'คูปองส่วนลด 500฿', points: 2000, type: 'coupon', value: 500, description: 'ใช้กับการซื้อครั้งละ 2,000 บาทขึ้นไป' },
            { id: 4, name: 'ฟรีส่ง (มูลค่า 50฿)', points: 300, type: 'coupon', value: 50, description: 'ฟรีค่าจัดส่งทุกพื้นที่ในประเทศ' },
            { id: 5, name: 'ส่วนลด 15%', points: 1500, type: 'percent', value: 15, maxDiscount: 300, description: 'ส่วนลด 15% สูงสุด 300 บาท' }
        ];

        // Initialize Admin User
        async function initializeAdminUser() {
            try {
                const adminRef = doc(db, 'users', 'admin_001');
                const adminSnap = await getDoc(adminRef);
                
                if (!adminSnap.exists()) {
                    const adminUser = {
                        uid: 'admin_001',
                        name: 'Admin Leismo',
                        email: 'admin@leismo.com',
                        points: 99999,
                        tier: 'Platinum',
                        isAdmin: true,
                        coupons: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    await setDoc(adminRef, adminUser);
                    console.log('Admin user created');
                }
            } catch (error) {
                console.error('Error initializing admin:', error);
            }
        }

        // Utility Functions
        function generateCouponCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'LEISMO';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function formatThaiDate(date) {
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Authentication Functions
        window.handleLogin = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');

            if (!email || !password) {
                showError('login-error', 'กรุณากรอกอีเมลและรหัสผ่าน');
                return;
            }

            submitBtn.textContent = 'กำลังเข้าสู่ระบบ...';
            submitBtn.disabled = true;

            try {
                // Check if admin login
                if (email === 'admin@leismo.com' && password === 'admin123') {
                    // Load admin user from Firestore
                    const adminRef = doc(db, 'users', 'admin_001');
                    const adminSnap = await getDoc(adminRef);
                    
                    if (adminSnap.exists()) {
                        window.currentUser = adminSnap.data();
                        window.isLoggedIn = true;
                        updateAuthUI();
                        hideError('login-error');
                        alert('เข้าสู่ระบบสำเร็จ!');
                        showPage('home');
                    }
                } else {
                    // Regular user login with Firebase Auth
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // Load user data from Firestore
                    const userRef = doc(db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        window.currentUser = userSnap.data();
                        window.isLoggedIn = true;
                        updateAuthUI();
                        hideError('login-error');
                        alert('เข้าสู่ระบบสำเร็จ!');
                        showPage('home');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/user-not-found') {
                    showError('login-error', 'ไม่พบบัญชีผู้ใช้นี้ กรุณาสมัครสมาชิกก่อน');
                } else if (error.code === 'auth/wrong-password') {
                    showError('login-error', 'รหัสผ่านไม่ถูกต้อง');
                } else if (error.code === 'auth/invalid-email') {
                    showError('login-error', 'รูปแบบอีเมลไม่ถูกต้อง');
                } else if (error.code === 'auth/too-many-requests') {
                    showError('login-error', 'มีการพยายามเข้าสู่ระบบมากเกินไป กรุณาลองใหม่ภายหลัง');
                } else {
                    showError('login-error', 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ กรุณาลองใหม่');
                }
            } finally {
                submitBtn.textContent = 'เข้าสู่ระบบ';
                submitBtn.disabled = false;
            }
        };

        window.handleRegister = async function(event) {
            event.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const birthDate = document.getElementById('register-birthdate').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');

            if (!name || !email || !password || !birthDate) {
                showError('register-error', 'กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            if (password.length < 6) {
                showError('register-error', 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }

            submitBtn.textContent = 'กำลังสมัคร...';
            submitBtn.disabled = true;

            try {
                // Create user with Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Create user document in Firestore
                const userData = {
                    uid: user.uid,
                    name: name,
                    email: email,
                    birthDate: birthDate,
                    points: 100,
                    tier: 'Bronze',
                    coupons: [],
                    isAdmin: false,
                    createdAt: new Date().toISOString()
                };

                await setDoc(doc(db, 'users', user.uid), userData);

                window.currentUser = userData;
                window.isLoggedIn = true;
                updateAuthUI();
                hideError('register-error');
                
                alert('สมัครสมาชิกสำเร็จ! ยินดีต้อนรับสู่ Leismo\nได้รับแต้มต้อนรับ 100 แต้ม');
                showPage('home');
                
            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showError('register-error', 'อีเมลนี้มีผู้ใช้แล้ว กรุณาใช้อีเมลอื่น');
                } else if (error.code === 'auth/invalid-email') {
                    showError('register-error', 'รูปแบบอีเมลไม่ถูกต้อง');
                } else if (error.code === 'auth/weak-password') {
                    showError('register-error', 'รหัสผ่านอ่อนแอเกินไป กรุณาใช้รหัสผ่านที่แข็งแกร่งกว่านี้');
                } else {
                    showError('register-error', 'เกิดข้อผิดพลาดในการสมัครสมาชิก กรุณาลองใหม่');
                }
            } finally {
                submitBtn.textContent = 'สมัครสมาชิก';
                submitBtn.disabled = false;
            }
        };

        window.logout = async function() {
            try {
                if (window.currentUser && !window.currentUser.isAdmin) {
                    await signOut(auth);
                }
                window.currentUser = null;
                window.isLoggedIn = false;
                updateAuthUI();
                showPage('home');
                alert('ออกจากระบบสำเร็จ');
            } catch (error) {
                console.error('Logout error:', error);
                alert('เกิดข้อผิดพลาดในการออกจากระบบ');
            }
        };

        // Listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            if (user && user.email !== 'admin@leismo.com') {
                try {
                    // Load user data from Firestore
                    const userRef = doc(db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        window.currentUser = userSnap.data();
                        window.isLoggedIn = true;
                        updateAuthUI();
                        console.log('User auto-logged in:', window.currentUser.name);
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            } else if (!user) {
                window.currentUser = null;
                window.isLoggedIn = false;
                updateAuthUI();
            }
        });

        // Navigation
        window.showPage = function(pageName) {
            const pages = ['home', 'login', 'register', 'loyalty', 'admin', 'scanner'];
            pages.forEach(page => {
                const pageElement = document.getElementById(`page-${page}`);
                if (pageElement) {
                    pageElement.classList.add('hidden');
                }
            });

            const targetPage = document.getElementById(`page-${pageName}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            updateNavigation(pageName);

            if (pageName === 'loyalty') {
                if (!window.isLoggedIn) {
                    showPage('login');
                    return;
                }
                updateLoyaltyPage();
            } else if (pageName === 'admin' || pageName === 'scanner') {
                if (!window.isLoggedIn || !window.currentUser?.isAdmin) {
                    alert('⚠️ ไม่มีสิทธิ์เข้าถึงหน้านี้\nเฉพาะแอดมินเท่านั้น');
                    showPage('home');
                    return;
                }
            }
        };

        function updateNavigation(currentPage) {
            const navItems = ['nav-home', 'nav-loyalty', 'nav-admin', 'nav-scanner'];
            navItems.forEach(navId => {
                const nav = document.getElementById(navId);
                if (nav) {
                    nav.style.color = '#6B7280';
                }
            });

            const currentNav = document.getElementById(`nav-${currentPage}`);
            if (currentNav) {
                currentNav.style.color = '#B19D87';
            }
        }

        function updateAuthUI() {
            const authButtons = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');
            const navLoyalty = document.getElementById('nav-loyalty');
            const navAdmin = document.getElementById('nav-admin');
            const navScanner = document.getElementById('nav-scanner');
            const homeAuthButtons = document.getElementById('home-auth-buttons');
            const homeLoyaltyButton = document.getElementById('home-loyalty-button');

            if (window.isLoggedIn && window.currentUser) {
                authButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                navLoyalty.classList.remove('hidden');
                
                if (window.currentUser.isAdmin) {
                    navAdmin.classList.remove('hidden');
                    navScanner.classList.remove('hidden');
                } else {
                    navAdmin.classList.add('hidden');
                    navScanner.classList.add('hidden');
                }
                
                document.getElementById('user-name').textContent = window.currentUser.name;
                document.getElementById('user-points').textContent = window.currentUser.points?.toLocaleString() || '0';

                homeAuthButtons.classList.add('hidden');
                homeLoyaltyButton.classList.remove('hidden');
            } else {
                authButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
                navLoyalty.classList.add('hidden');
                navAdmin.classList.add('hidden');
                navScanner.classList.add('hidden');

                homeAuthButtons.classList.remove('hidden');
                homeLoyaltyButton.classList.add('hidden');
            }
        }

        // Loyalty Functions
        window.showLoyaltyTab = function(tabName) {
            const contents = document.querySelectorAll('.loyalty-content');
            contents.forEach(content => content.classList.add('hidden'));

            document.getElementById(`loyalty-${tabName}`).classList.remove('hidden');

            const tabs = document.querySelectorAll('.loyalty-tab');
            tabs.forEach(tab => {
                tab.style.color = '#6B7280';
                tab.style.borderColor = 'transparent';
                tab.classList.remove('border-b-2');
            });

            event.target.style.color = '#B19D87';
            event.target.style.borderColor = '#B19D87';
            event.target.classList.add('border-b-2');

            if (tabName === 'rewards') {
                loadRewards();
            } else if (tabName === 'coupons') {
                loadCoupons();
            }
        };

        function updateLoyaltyPage() {
            if (!window.currentUser) return;

            document.getElementById('loyalty-user-name').textContent = window.currentUser.name;
            document.getElementById('loyalty-user-tier').textContent = window.currentUser.tier;
            document.getElementById('loyalty-user-points').textContent = window.currentUser.points?.toLocaleString() || '0';

            document.getElementById('dashboard-tier').textContent = window.currentUser.tier;
            document.getElementById('dashboard-points').textContent = window.currentUser.points?.toLocaleString() || '0';
            document.getElementById('dashboard-coupons').textContent = (window.currentUser.coupons || []).filter(c => !c.used).length;
        }

        function loadRewards() {
            const container = document.getElementById('rewards-container');
            container.innerHTML = '';

            rewards.forEach(reward => {
                const canRedeem = window.currentUser && window.currentUser.points >= reward.points;
                const rewardDiv = document.createElement('div');
                rewardDiv.className = 'border rounded-lg p-6 text-center hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1';
                rewardDiv.style.borderColor = '#DACFBD';

                rewardDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="text-6xl mb-2">🎁</div>
                        <div class="text-2xl font-bold mb-1" style="color: #B19D87;">
                            ${reward.type === 'coupon' ? `฿${reward.value}` : `${reward.value}%`}
                        </div>
                    </div>
                    <h4 class="font-semibold mb-2" style="color: #B19D87;">${reward.name}</h4>
                    <p class="text-sm text-gray-600 mb-3">${reward.description}</p>
                    <p class="text-2xl font-bold mb-4" style="color: #B19D87;">
                        ${reward.points.toLocaleString()} แต้ม
                    </p>
                    <button onclick="redeemReward(${reward.id})" 
                            ${!canRedeem ? 'disabled' : ''} 
                            class="w-full py-3 rounded-lg font-semibold transition-all duration-200 ${canRedeem ? 'text-white hover:opacity-90 hover:shadow-lg transform hover:scale-105' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
                            ${canRedeem ? 'style="background-color: #B19D87;"' : ''}>
                        ${canRedeem ? '🎯 แลกเลย' : '❌ แต้มไม่พอ'}
                    </button>
                `;

                container.appendChild(rewardDiv);
            });
        }

        function loadCoupons() {
            const container = document.getElementById('coupons-container');
            const userCoupons = window.currentUser?.coupons || [];

            if (userCoupons.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-8xl mb-4">🎁</div>
                        <p class="text-gray-500 text-lg">ยังไม่มีคูปอง</p>
                        <p class="text-gray-400">แลกแต้มเพื่อรับคูปองส่วนลด</p>
                        <button onclick="showLoyaltyTab('rewards')" class="mt-4 text-white px-6 py-2 rounded-lg hover:opacity-90" style="background-color: #B19D87;">
                            ไปแลกคูปอง
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>';
            const grid = container.querySelector('.grid');

            userCoupons.forEach((coupon) => {
                const isExpired = new Date() > new Date(coupon.expiryTimestamp || coupon.expiryDate);
                const couponDiv = document.createElement('div');
                couponDiv.className = `border rounded-lg p-6 transition-all duration-200 hover:shadow-lg cursor-pointer ${
                    coupon.used ? 'opacity-50 bg-gray-50 border-gray-300' : 
                    isExpired ? 'opacity-60 bg-red-50 border-red-200' :
                    'bg-white border-dashed hover:scale-105'
                }`;
                couponDiv.style.borderColor = coupon.used ? '#ccc' : isExpired ? '#fecaca' : '#B19D87';

                couponDiv.onclick = () => {
                    if (!coupon.used && !isExpired) {
                        window.currentCoupon = coupon;
                        showCouponModal(coupon);
                    }
                };

                const statusIcon = coupon.used ? '✅' : isExpired ? '⏰' : '🎫';
                const statusText = coupon.used ? 'ใช้แล้ว' : isExpired ? 'หมดอายุ' : 'ใช้ได้';
                const statusColor = coupon.used ? 'bg-gray-100 text-gray-600' : 
                                   isExpired ? 'bg-red-100 text-red-600' : 
                                   'bg-green-100 text-green-600';

                couponDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1" style="color: #B19D87;">${coupon.name}</h4>
                            <p class="text-sm text-gray-600 mb-2">${coupon.description || 'คูปองส่วนลดพิเศษจาก Leismo'}</p>
                            <p class="text-xs text-gray-500">โค้ด: <span class="font-mono font-semibold">${coupon.code}</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold" style="color: #B19D87;">
                                ${coupon.type === 'coupon' ? `฿${coupon.value}` : `${coupon.value}%`}
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm text-gray-600">
                            <p>ได้รับ: ${coupon.createdDate}</p>
                            <p>หมดอายุ: ${coupon.expiryDate}</p>
                        </div>
                        <div class="text-center py-2 px-4 rounded-full text-sm font-semibold ${statusColor}">
                            ${statusIcon} ${statusText}
                        </div>
                    </div>
                    ${!coupon.used && !isExpired ? `
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800 mb-2">💡 <strong>คลิกเพื่อดูรายละเอียด</strong></p>
                            <p class="text-xs text-blue-600">• ดู QR Code สำหรับแอดมิน</p>
                            <p class="text-xs text-blue-600">• บันทึกรูปภาพคูปอง</p>
                        </div>
                    ` : ''}
                `;

                grid.appendChild(couponDiv);
            });
        }

        // Coupon Functions
        window.redeemReward = async function(rewardId) {
            if (!window.currentUser) {
                alert('กรุณาเข้าสู่ระบบก่อน');
                return;
            }

            const reward = rewards.find(r => r.id === rewardId);
            if (!reward) {
                alert('ไม่พบข้อมูลของรางวัล');
                return;
            }

            if (window.currentUser.points < reward.points) {
                alert('แต้มไม่พอสำหรับแลกของรางวัลนี้');
                return;
            }

            try {
                const couponCode = generateCouponCode();
                const createdDate = new Date();
                const expiryDate = new Date(createdDate.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                const newCoupon = {
                    id: Date.now().toString(),
                    code: couponCode,
                    name: reward.name,
                    type: reward.type,
                    value: reward.value,
                    maxDiscount: reward.maxDiscount || null,
                    description: reward.description,
                    used: false,
                    createdDate: formatThaiDate(createdDate),
                    expiryDate: formatThaiDate(expiryDate),
                    createdTimestamp: createdDate.toISOString(),
                    expiryTimestamp: expiryDate.toISOString(),
                    userId: window.currentUser.uid,
                    userName: window.currentUser.name
                };

                // Update user data
                window.currentUser.points -= reward.points;
                window.currentUser.coupons = window.currentUser.coupons || [];
                window.currentUser.coupons.push(newCoupon);

                // Update in Firestore
                const userRef = doc(db, 'users', window.currentUser.uid);
                await updateDoc(userRef, {
                    points: window.currentUser.points,
                    coupons: window.currentUser.coupons
                });

                window.currentCoupon = newCoupon;
                showCouponModal(newCoupon);
                updateLoyaltyPage();
                updateAuthUI();

                console.log('Coupon redeemed successfully:', newCoupon);

            } catch (error) {
                console.error('Redeem error:', error);
                alert('เกิดข้อผิดพลาดในการแลกของรางวัล');
            }
        };

        function showCouponModal(coupon) {
            document.getElementById('coupon-display-name').textContent = coupon.name;
            document.getElementById('coupon-display-code').textContent = coupon.code;
            document.getElementById('coupon-created-date').textContent = coupon.createdDate;
            document.getElementById('coupon-expiry-date').textContent = coupon.expiryDate;
            
            const valueDisplay = document.getElementById('coupon-display-value');
            if (coupon.type === 'coupon') {
                valueDisplay.textContent = `฿${coupon.value}`;
            } else {
                valueDisplay.textContent = `${coupon.value}%`;
            }

            setTimeout(() => {
                generateQRCode(coupon);
            }, 100);

            document.getElementById('coupon-modal').classList.remove('hidden');
        }

        function generateQRCode(coupon) {
            const canvas = document.getElementById('qr-code');
            if (!canvas) return;
            
            const qrData = {
                type: 'LEISMO_COUPON',
                code: coupon.code,
                id: coupon.id,
                value: coupon.value,
                couponType: coupon.type,
                userId: coupon.userId || window.currentUser?.uid,
                userName: coupon.userName || window.currentUser?.name,
                created: coupon.createdTimestamp,
                expiry: coupon.expiryTimestamp,
                verification: `leismo-verify-${coupon.code}`
            };

            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(canvas, JSON.stringify(qrData<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leismo - Fashion Loyalty System</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        .brand-color { color: #B19D87; }
        .brand-bg { background-color: #B19D87; }
        .brand-border { border-color: #B19D87; }
        .secondary-bg { background-color: #DACFBD; }
        .gradient-bg { background: linear-gradient(to right, #B19D87, #DACFBD); }
        .hidden { display: none; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .coupon-card {
            background: linear-gradient(135deg, #B19D87 0%, #DACFBD 100%);
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b" style="border-color: #DACFBD;">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center gap-8">
                    <div class="cursor-pointer" onclick="showPage('home')">
                        <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-8 w-auto">
                    </div>
                    <nav class="hidden md:flex items-center gap-8">
                        <button onclick="showPage('home')" class="font-medium transition-colors text-gray-700 hover:opacity-75" id="nav-home">หน้าแรก</button>
                        <button onclick="showPage('loyalty')" class="font-medium transition-colors text-gray-700 hover:opacity-75 hidden" id="nav-loyalty">⭐ Loyalty Card</button>
                        <button onclick="showPage('admin')" class="font-medium transition-colors text-gray-700 hover:opacity-75 hidden" id="nav-admin">⚙️ Admin Panel</button>
                        <button onclick="showPage('scanner')" class="font-medium transition-colors text-gray-700 hover:opacity-75 hidden" id="nav-scanner">📱 Scanner</button>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-4" id="auth-buttons">
                        <button onclick="showPage('login')" class="hover:opacity-90 transition-colors font-medium brand-color">เข้าสู่ระบบ</button>
                        <button onclick="showPage('register')" class="bg-transparent border-2 px-4 py-2 rounded-lg hover:bg-opacity-10 transition-colors font-medium brand-color brand-border">สมัครสมาชิก</button>
                    </div>
                    <div class="flex items-center gap-4 hidden" id="user-info">
                        <div class="flex items-center gap-2">
                            <span class="text-yellow-500">⭐</span>
                            <span class="font-semibold brand-color" id="user-points">0</span>
                            <span class="text-sm text-gray-600">แต้ม</span>
                        </div>
                        <span class="text-gray-600">สวัสดี</span>
                        <span class="font-semibold brand-color" id="user-name"></span>
                        <button onclick="logout()" class="hover:opacity-90 transition-colors font-medium text-gray-600 hover:text-red-600">ออกจากระบบ</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Home Page -->
    <div id="page-home" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="text-center px-4">
            <div class="mb-12">
                <img src="https://i.ibb.co/ds77x4rr/Leismo-Primarylogo-SItypo.png" alt="Leismo Logo" class="h-16 w-auto mx-auto">
            </div>
            
            <p class="text-xl mb-12 text-white font-light tracking-wide max-w-md mx-auto" style="font-family: serif; font-style: italic; letter-spacing: 2.5px;">
                A Subtle Weave of Enduring Refinement
            </p>
            
            <div class="space-y-4">
                <button class="bg-white px-12 py-4 rounded-full font-semibold text-lg hover:bg-opacity-90 transition-colors shadow-lg brand-color">
                    ดูคอลเล็กชัน
                </button>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center" id="home-auth-buttons">
                    <button onclick="showPage('login')" class="border-2 border-white text-white px-8 py-3 rounded-full font-semibold hover:bg-white hover:text-gray-800 transition-colors">
                        เข้าสู่ระบบ
                    </button>
                    <button onclick="showPage('register')" class="bg-white px-8 py-3 rounded-full font-semibold hover:bg-opacity-90 transition-colors brand-color">
                        สมัครสมาชิก
                    </button>
                </div>

                <div class="hidden" id="home-loyalty-button">
                    <button onclick="showPage('loyalty')" class="bg-yellow-500 text-white px-8 py-3 rounded-full font-semibold hover:bg-yellow-600 transition-colors shadow-lg">
                        <span class="inline-block mr-2">⭐</span>
                        ระบบสมาชิก Loyalty
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="page-login" class="hidden min-h-screen flex items-center justify-center py-12 px-4" style="background: linear-gradient(to bottom right, #DACFBD, #B19D87)">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-12 w-auto mx-auto mb-4 cursor-pointer" onclick="showPage('home')">
                <h2 class="text-2xl font-bold brand-color">เข้าสู่ระบบ</h2>
            </div>
            
            <div id="login-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">อีเมล</label>
                    <input type="email" id="login-email" required class="w-full p-3 border rounded-lg" placeholder="admin@leismo.com">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">รหัสผ่าน</label>
                    <input type="password" id="login-password" required class="w-full p-3 border rounded-lg" placeholder="admin123">
                </div>
                <button type="submit" class="w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-colors shadow-lg brand-bg">
                    เข้าสู่ระบบ
                </button>
            </form>
            
            <p class="text-center mt-4 text-gray-600">
                ยังไม่มีบัญชี? <button onclick="showPage('register')" class="hover:underline brand-color">สมัครสมาชิก</button>
            </p>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-800 font-semibold">💡 สำหรับทดสอบ Admin:</p>
                <p class="text-xs text-blue-600">Email: admin@leismo.com | Password: admin123</p>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="page-register" class="hidden min-h-screen flex items-center justify-center py-12 px-4" style="background: linear-gradient(to bottom right, #DACFBD, #B19D87)">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <img src="https://i.ibb.co/JWHq77Fr/Leismo-Primarylogo-MBGtypo.png" alt="Leismo Logo" class="h-12 w-auto mx-auto mb-4 cursor-pointer" onclick="showPage('home')">
                <h2 class="text-2xl font-bold brand-color">สมัครสมาชิก</h2>
            </div>
            
            <div id="register-error" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
            
            <form onsubmit="handleRegister(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">ชื่อ-นามสกุล *</label>
                    <input type="text" id="register-name" required class="w-full p-3 border rounded-lg" placeholder="กรอกชื่อ-นามสกุล">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">อีเมล *</label>
                    <input type="email" id="register-email" required class="w-full p-3 border rounded-lg" placeholder="example@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">รหัสผ่าน *</label>
                    <input type="password" id="register-password" required minlength="6" class="w-full p-3 border rounded-lg" placeholder="รหัสผ่านอย่างน้อย 6 ตัวอักษร">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 brand-color">วันเดือนปีเกิด *</label>
                    <input type="date" id="register-birthdate" required class="w-full p-3 border rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">🎉 รับส่วนลดพิเศษในวันเกิดของคุณ!</p>
                </div>
                <button type="submit" class="w-full text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-colors shadow-lg brand-bg">
                    สมัครสมาชิก
                </button>
            </form>
            
            <p class="text-center mt-4 text-gray-600">
                มีบัญชีแล้ว? <button onclick="showPage('login')" class="hover:underline brand-color">เข้าสู่ระบบ</button>
            </p>
        </div>
    </div>

    <!-- Loyalty Page -->
    <div id="page-loyalty" class="hidden min-h-screen py-8 px-4 secondary-bg">
        <div class="container mx-auto max-w-6xl">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8 border mb-8">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 brand-color">
                    สวัสดี <span id="loyalty-user-name"></span>
                </h1>
                <p class="text-lg mb-8 brand-color">
                    สมาชิก <span id="loyalty-user-tier"></span> | <span id="loyalty-user-points"></span> แต้ม
                </p>

                <!-- Navigation Tabs -->
                <div class="flex border-b mb-8">
                    <button onclick="showLoyaltyTab('dashboard')" class="loyalty-tab flex-1 py-4 px-6 font-semibold transition-colors border-b-2 brand-color" style="border-color: #B19D87; color: #B19D87;">
                        ⭐ แดชบอร์ด
                    </button>
                    <button onclick="showLoyaltyTab('rewards')" class="loyalty-tab flex-1 py-4 px-6 font-semibold transition-colors text-gray-600 hover:bg-gray-50">
                        🎁 แลกของรางวัล
                    </button>
                    <button onclick="showLoyaltyTab('coupons')" class="loyalty-tab flex-1 py-4 px-6 font-semibold transition-colors text-gray-600 hover:bg-gray-50">
                        🏆 คูปองของฉัน
                    </button>
                </div>

                <!-- Dashboard Tab -->
                <div id="loyalty-dashboard" class="loyalty-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-6xl mb-4">🏆</div>
                            <h3 class="text-xl font-semibold mb-2 brand-color">ระดับสมาชิก</h3>
                            <p class="text-2xl font-bold brand-color" id="dashboard-tier">Bronze</p>
                        </div>
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-6xl mb-4">⭐</div>
                            <h3 class="text-xl font-semibold mb-2 brand-color">แต้มสะสม</h3>
                            <p class="text-2xl font-bold brand-color" id="dashboard-points">0</p>
                        </div>
                        <div class="text-center p-6 rounded-lg secondary-bg">
                            <div class="text-6xl mb-4">🎁</div>
                            <h3 class="text-xl font-semibold mb-2 brand-color">คูปองที่มี</h3>
                            <p class="text-2xl font-bold brand-color" id="dashboard-coupons">0</p>
                        </div>
                    </div>
                </div>

                <!-- Rewards Tab -->
                <div id="loyalty-rewards" class="loyalty-content hidden">
                    <h3 class="text-xl font-semibold mb-6 text-center brand-color">แลกของรางวัลด้วยแต้มสะสม</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="rewards-container">
                        <!-- Rewards will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Coupons Tab -->
                <div id="loyalty-coupons" class="loyalty-content hidden">
                    <h3 class="text-xl font-semibold mb-6 text-center brand-color">คูปองส่วนลดของฉัน</h3>
                    <div id="coupons-container">
                        <!-- Coupons will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="page-admin" class="hidden min-h-screen py-8 px-4 secondary-bg">
        <div class="container mx-auto max-w-7xl">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 brand-color">🔐 Admin Panel</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="text-center p-6 rounded-lg secondary-bg">
                        <div class="text-4xl mb-2">👥</div>
                        <h3 class="text-lg font-semibold mb-2 brand-color">ผู้ใช้ทั้งหมด</h3>
                        <p class="text-2xl font-bold brand-color">5</p>
                    </div>
                    <div class="text-center p-6 rounded-lg secondary-bg">
                        <div class="text-4xl mb-2">⭐</div>
                        <h3 class="text-lg font-semibold mb-2 brand-color">แต้มรวม</h3>
                        <p class="text-2xl font-bold brand-color">12,500</p>
                    </div>
                    <div class="text-center p-6 rounded-lg secondary-bg">
                        <div class="text-4xl mb-2">🎫</div>
                        <h3 class="text-lg font-semibold mb-2 brand-color">คูปองแลกแล้ว</h3>
                        <p class="text-2xl font-bold brand-color">25</p>
                    </div>
                    <div class="text-center p-6 rounded-lg secondary-bg">
                        <div class="text-4xl mb-2">💰</div>
                        <h3 class="text-lg font-semibold mb-2 brand-color">มูลค่าส่วนลด</h3>
                        <p class="text-2xl font-bold brand-color">5,000฿</p>
                    </div>
                </div>
                
                <div class="text-center py-12">
                    <p class="text-gray-500">ระบบ Admin Panel จะเพิ่มเติมในเร็วๆ นี้</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Page -->
    <div id="page-scanner" class="hidden min-h-screen py-8 px-4 secondary-bg">
        <div class="container mx-auto max-w-4xl">
            <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 brand-color">📱 Coupon Scanner</h1>
                
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">📱</div>
                    <h3 class="text-xl font-semibold mb-4 brand-color">สแกน QR Code คูปอง</h3>
                    <p class="text-gray-600 mb-6">ให้ลูกค้าแสดง QR Code แล้วกดสแกน</p>
                </div>
                
                <div class="max-w-md mx-auto">
                    <h4 class="font-semibold mb-4 brand-color">ใส่ข้อมูล QR Code</h4>
                    <div class="space-y-4">
                        <textarea id="qr-data-input" rows="4" class="w-full p-3 border rounded-lg" placeholder='วาง JSON ข้อมูล QR Code ที่นี่...'></textarea>
                        <button onclick="processQRData()" class="w-full brand-bg text-white py-3 rounded-lg hover:opacity-90">
                            ตรวจสอบข้อมูล
                        </button>
                    </div>
                </div>
                
                <div id="coupon-verification-result" class="hidden mt-8">
                    <!-- Results will show here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="coupon-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl">
            <div class="p-6 border-b text-center">
                <div class="text-4xl mb-2">🎉</div>
                <h2 class="text-2xl font-bold brand-color">แลกคูปองสำเร็จ!</h2>
                <p class="text-gray-600 mt-2">กรุณาบันทึกรูปภาพนี้และส่งให้แอดมิน</p>
            </div>
            
            <div class="p-6">
                <div class="coupon-card rounded-2xl p-6 text-white text-center mb-6 shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <img src="https://i.ibb.co/ds77x4rr/Leismo-Primarylogo-SItypo.png" alt="Leismo" class="h-8 w-auto">
                        <div class="text-right">
                            <div class="text-2xl font-bold" id="coupon-display-value">฿100</div>
                            <div class="text-sm opacity-90">ส่วนลด</div>
                        </div>
                    </div>
                    
                    <div class="border-2 border-white border-dashed rounded-lg p-4 mb-4">
                        <div class="text-lg font-semibold mb-2" id="coupon-display-name">คูปองส่วนลด 100฿</div>
                        <div class="text-xl font-mono tracking-wider font-bold" id="coupon-display-code">LEISMO123456</div>
                    </div>
                    
                    <div class="flex justify-between text-sm opacity-90">
                        <span>ได้รับ: <span id="coupon-created-date"></span></span>
                        <span>หมดอายุ: <span id="coupon-expiry-date"></span></span>
                    </div>
                </div>

                <div class="text-center mb-6">
                    <h3 class="text-lg font-semibold mb-4 brand-color">QR Code สำหรับแอดมินตรวจสอบ</h3>
                    <div class="bg-white p-4 rounded-lg border-2 inline-block" style="border-color: #B19D87;">
                        <canvas id="qr-code" class="mx-auto"></canvas>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-blue-800 mb-2">📋 วิธีการใช้งาน</h4>
                    <ol class="text-sm text-blue-700 space-y-1">
                        <li>1. บันทึกรูปภาพคูปองนี้</li>
                        <li>2. ส่งรูปภาพให้แอดมินผ่านทาง Line</li>
                        <li>3. แจ้งสินค้าที่ต้องการใช้ส่วนลด</li>
                        <li>4. รอแอดมินตรวจสอบและยืนยัน</li>
                    </ol>
                </div>

                <div class="bg-orange-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-orange-800 mb-2">⚠️ หมายเหตุสำคัญ</h4>
                    <ul class="text-sm text-orange-700 space-y-1">
                        <li>• คูปองมีอายุ 7 วัน หลังจากแลก</li>
                        <li>• ใช้ได้เฉพาะ 1 ครั้งเท่านั้น</li>
                        <li>• ต้องติดต่อแอดมินก่อนใช้งาน</li>
                    </ul>
                </div>
            </div>

            <div class="p-6 border-t bg-gray-50 flex gap-4">
                <button onclick="downloadCoupon()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600">
                    💾 บันทึกรูปภาพ
                </button>
                <button onclick="closeCouponModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600">
                    ปิด
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        window.currentUser = null;
        window.isLoggedIn = false;
        window.currentCoupon = null;

        // Mock data
        const rewards = [
            { id: 1, name: 'คูปองส่วนลด 100฿', points: 500, type: 'coupon', value: 100, description: 'ใช้กับสินค้าทุกชิ้น ยกเว้นสินค้าลดราคา' },
            { id: 2, name: 'คูปองส่วนลด 250฿', points: 1000, type: 'coupon', value: 250, description: 'ใช้กับสินค้าทุกชิ้น ยื่อสุด 250 บาท' },
            { id: 3, name: 'คูปองส่วนลด 500฿', points: 2000, type: 'coupon', value: 500, description: 'ใช้กับการซื้อครั้งละ 2,000 บาทขึ้นไป' },
            { id: 4, name: 'ฟรีส่ง (มูลค่า 50฿)', points: 300, type: 'coupon', value: 50, description: 'ฟรีค่าจัดส่งทุกพื้นที่ในประเทศ' },
            { id: 5, name: 'ส่วนลด 15%', points: 1500, type: 'percent', value: 15, maxDiscount: 300, description: 'ส่วนลด 15% สูงสุด 300 บาท' }
        ];

        // Utility Functions
        function generateCouponCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'LEISMO';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function formatThaiDate(date) {
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Navigation
        window.showPage = function(pageName) {
            const pages = ['home', 'login', 'register', 'loyalty', 'admin', 'scanner'];
            pages.forEach(page => {
                const pageElement = document.getElementById(`page-${page}`);
                if (pageElement) {
                    pageElement.classList.add('hidden');
                }
            });

            const targetPage = document.getElementById(`page-${pageName}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            updateNavigation(pageName);

            if (pageName === 'loyalty') {
                if (!window.isLoggedIn) {
                    showPage('login');
                    return;
                }
                updateLoyaltyPage();
            } else if (pageName === 'admin' || pageName === 'scanner') {
                if (!window.isLoggedIn || !window.currentUser?.isAdmin) {
                    alert('⚠️ ไม่มีสิทธิ์เข้าถึงหน้านี้\nเฉพาะแอดมินเท่านั้น');
                    showPage('home');
                    return;
                }
            }
        };

        function updateNavigation(currentPage) {
            const navItems = ['nav-home', 'nav-loyalty', 'nav-admin', 'nav-scanner'];
            navItems.forEach(navId => {
                const nav = document.getElementById(navId);
                if (nav) {
                    nav.style.color = '#6B7280';
                }
            });

            const currentNav = document.getElementById(`nav-${currentPage}`);
            if (currentNav) {
                currentNav.style.color = '#B19D87';
            }
        }

        // Authentication
        window.handleLogin = function(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showError('login-error', 'กรุณากรอกอีเมลและรหัสผ่าน');
                return;
            }

            if (email === 'admin@leismo.com' && password === 'admin123') {
                window.currentUser = {
                    name: 'Admin Leismo',
                    email: 'admin@leismo.com',
                    points: 99999,
                    tier: 'Platinum',
                    isAdmin: true,
                    coupons: []
                };
            } else {
                window.currentUser = {
                    name: email.split('@')[0],
                    email: email,
                    points: 1500,
                    tier: 'Bronze',
                    isAdmin: false,
                    coupons: []
                };
            }

            window.isLoggedIn = true;
            updateAuthUI();
            hideError('login-error');
            alert('เข้าสู่ระบบสำเร็จ!');
            showPage('home');
        };

        window.handleRegister = function(event) {
            event.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const birthDate = document.getElementById('register-birthdate').value;

            if (!name || !email || !password || !birthDate) {
                showError('register-error', 'กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            if (password.length < 6) {
                showError('register-error', 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }

            window.currentUser = {
                name: name,
                email: email,
                birthDate: birthDate,
                points: 100,
                tier: 'Bronze',
                coupons: [],
                isAdmin: false
            };
            
            window.isLoggedIn = true;
            updateAuthUI();
            hideError('register-error');
            alert('สมัครสมาชิกสำเร็จ! ยินดีต้อนรับสู่ Leismo');
            showPage('home');
        };

        window.logout = function() {
            window.currentUser = null;
            window.isLoggedIn = false;
            updateAuthUI();
            showPage('home');
        };

        function updateAuthUI() {
            const authButtons = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');
            const navLoyalty = document.getElementById('nav-loyalty');
            const navAdmin = document.getElementById('nav-admin');
            const navScanner = document.getElementById('nav-scanner');
            const homeAuthButtons = document.getElementById('home-auth-buttons');
            const homeLoyaltyButton = document.getElementById('home-loyalty-button');

            if (window.isLoggedIn && window.currentUser) {
                authButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                navLoyalty.classList.remove('hidden');
                
                if (window.currentUser.isAdmin) {
                    navAdmin.classList.remove('hidden');
                    navScanner.classList.remove('hidden');
                } else {
                    navAdmin.classList.add('hidden');
                    navScanner.classList.add('hidden');
                }
                
                document.getElementById('user-name').textContent = window.currentUser.name;
                document.getElementById('user-points').textContent = window.currentUser.points?.toLocaleString() || '0';

                homeAuthButtons.classList.add('hidden');
                homeLoyaltyButton.classList.remove('hidden');
            } else {
                authButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
                navLoyalty.classList.add('hidden');
                navAdmin.classList.add('hidden');
                navScanner.classList.add('hidden');

                homeAuthButtons.classList.remove('hidden');
                homeLoyaltyButton.classList.add('hidden');
            }
        }

        // Loyalty Functions
        window.showLoyaltyTab = function(tabName) {
            const contents = document.querySelectorAll('.loyalty-content');
            contents.forEach(content => content.classList.add('hidden'));

            document.getElementById(`loyalty-${tabName}`).classList.remove('hidden');

            const tabs = document.querySelectorAll('.loyalty-tab');
            tabs.forEach(tab => {
                tab.style.color = '#6B7280';
                tab.style.borderColor = 'transparent';
                tab.classList.remove('border-b-2');
            });

            event.target.style.color = '#B19D87';
            event.target.style.borderColor = '#B19D87';
            event.target.classList.add('border-b-2');

            if (tabName === 'rewards') {
                loadRewards();
            } else if (tabName === 'coupons') {
                loadCoupons();
            }
        };

        function updateLoyaltyPage() {
            if (!window.currentUser) return;

            document.getElementById('loyalty-user-name').textContent = window.currentUser.name;
            document.getElementById('loyalty-user-tier').textContent = window.currentUser.tier;
            document.getElementById('loyalty-user-points').textContent = window.currentUser.points?.toLocaleString() || '0';

            document.getElementById('dashboard-tier').textContent = window.currentUser.tier;
            document.getElementById('dashboard-points').textContent = window.currentUser.points?.toLocaleString() || '0';
            document.getElementById('dashboard-coupons').textContent = (window.currentUser.coupons || []).filter(c => !c.used).length;
        }

        function loadRewards() {
            const container = document.getElementById('rewards-container');
            container.innerHTML = '';

            rewards.forEach(reward => {
                const canRedeem = window.currentUser && window.currentUser.points >= reward.points;
                const rewardDiv = document.createElement('div');
                rewardDiv.className = 'border rounded-lg p-6 text-center hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1';
                rewardDiv.style.borderColor = '#DACFBD';

                rewardDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="text-6xl mb-2">🎁</div>
                        <div class="text-2xl font-bold mb-1" style="color: #B19D87;">
                            ${reward.type === 'coupon' ? `฿${reward.value}` : `${reward.value}%`}
                        </div>
                    </div>
                    <h4 class="font-semibold mb-2" style="color: #B19D87;">${reward.name}</h4>
                    <p class="text-sm text-gray-600 mb-3">${reward.description}</p>
                    <p class="text-2xl font-bold mb-4" style="color: #B19D87;">
                        ${reward.points.toLocaleString()} แต้ม
                    </p>
                    <button onclick="redeemReward(${reward.id})" 
                            ${!canRedeem ? 'disabled' : ''} 
                            class="w-full py-3 rounded-lg font-semibold transition-all duration-200 ${canRedeem ? 'text-white hover:opacity-90 hover:shadow-lg transform hover:scale-105' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
                            ${canRedeem ? 'style="background-color: #B19D87;"' : ''}>
                        ${canRedeem ? '🎯 แลกเลย' : '❌ แต้มไม่พอ'}
                    </button>
                `;

                container.appendChild(rewardDiv);
            });
        }

        function loadCoupons() {
            const container = document.getElementById('coupons-container');
            const userCoupons = window.currentUser?.coupons || [];

            if (userCoupons.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-8xl mb-4">🎁</div>
                        <p class="text-gray-500 text-lg">ยังไม่มีคูปอง</p>
                        <p class="text-gray-400">แลกแต้มเพื่อรับคูปองส่วนลด</p>
                        <button onclick="showLoyaltyTab('rewards')" class="mt-4 text-white px-6 py-2 rounded-lg hover:opacity-90" style="background-color: #B19D87;">
                            ไปแลกคูปอง
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>';
            const grid = container.querySelector('.grid');

            userCoupons.forEach((coupon) => {
                const isExpired = new Date() > new Date(coupon.expiryTimestamp || coupon.expiryDate);
                const couponDiv = document.createElement('div');
                couponDiv.className = `border rounded-lg p-6 transition-all duration-200 hover:shadow-lg cursor-pointer ${
                    coupon.used ? 'opacity-50 bg-gray-50 border-gray-300' : 
                    isExpired ? 'opacity-60 bg-red-50 border-red-200' :
                    'bg-white border-dashed hover:scale-105'
                }`;
                couponDiv.style.borderColor = coupon.used ? '#ccc' : isExpired ? '#fecaca' : '#B19D87';

                couponDiv.onclick = () => {
                    if (!coupon.used && !isExpired) {
                        window.currentCoupon = coupon;
                        showCouponModal(coupon);
                    }
                };

                const statusIcon = coupon.used ? '✅' : isExpired ? '⏰' : '🎫';
                const statusText = coupon.used ? 'ใช้แล้ว' : isExpired ? 'หมดอายุ' : 'ใช้ได้';
                const statusColor = coupon.used ? 'bg-gray-100 text-gray-600' : 
                                   isExpired ? 'bg-red-100 text-red-600' : 
                                   'bg-green-100 text-green-600';

                couponDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1" style="color: #B19D87;">${coupon.name}</h4>
                            <p class="text-sm text-gray-600 mb-2">${coupon.description || 'คูปองส่วนลดพิเศษจาก Leismo'}</p>
                            <p class="text-xs text-gray-500">โค้ด: <span class="font-mono font-semibold">${coupon.code}</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold" style="color: #B19D87;">
                                ${coupon.type === 'coupon' ? `฿${coupon.value}` : `${coupon.value}%`}
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm text-gray-600">
                            <p>ได้รับ: ${coupon.createdDate}</p>
                            <p>หมดอายุ: ${coupon.expiryDate}</p>
                        </div>
                        <div class="text-center py-2 px-4 rounded-full text-sm font-semibold ${statusColor}">
                            ${statusIcon} ${statusText}
                        </div>
                    </div>
                    ${!coupon.used && !isExpired ? `
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800 mb-2">💡 <strong>คลิกเพื่อดูรายละเอียด</strong></p>
                            <p class="text-xs text-blue-600">• ดู QR Code สำหรับแอดมิน</p>
                            <p class="text-xs text-blue-600">• บันทึกรูปภาพคูปอง</p>
                        </div>
                    ` : ''}
                `;

                grid.appendChild(couponDiv);
            });
        }

        // Coupon Functions
        window.redeemReward = function(rewardId) {
            if (!window.currentUser) {
                alert('กรุณาเข้าสู่ระบบก่อน');
                return;
            }

            const reward = rewards.find(r => r.id === rewardId);
            if (!reward) {
                alert('ไม่พบข้อมูลของรางวัล');
                return;
            }

            if (window.currentUser.points < reward.points) {
                alert('แต้มไม่พอสำหรับแลกของรางวัลนี้');
                return;
            }

            const couponCode = generateCouponCode();
            const createdDate = new Date();
            const expiryDate = new Date(createdDate.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const newCoupon = {
                id: Date.now().toString(),
                code: couponCode,
                name: reward.name,
                type: reward.type,
                value: reward.value,
                maxDiscount: reward.maxDiscount || null,
                description: reward.description,
                used: false,
                createdDate: formatThaiDate(createdDate),
                expiryDate: formatThaiDate(expiryDate),
                createdTimestamp: createdDate.toISOString(),
                expiryTimestamp: expiryDate.toISOString()
            };

            window.currentUser.points -= reward.points;
            window.currentUser.coupons = window.currentUser.coupons || [];
            window.currentUser.coupons.push(newCoupon);
            window.currentCoupon = newCoupon;

            showCouponModal(newCoupon);
            updateLoyaltyPage();
            updateAuthUI();
        };

        function showCouponModal(coupon) {
            document.getElementById('coupon-display-name').textContent = coupon.name;
            document.getElementById('coupon-display-code').textContent = coupon.code;
            document.getElementById('coupon-created-date').textContent = coupon.createdDate;
            document.getElementById('coupon-expiry-date').textContent = coupon.expiryDate;
            
            const valueDisplay = document.getElementById('coupon-display-value');
            if (coupon.type === 'coupon') {
                valueDisplay.textContent = `฿${coupon.value}`;
            } else {
                valueDisplay.textContent = `${coupon.value}%`;
            }

            setTimeout(() => {
                generateQRCode(coupon);
            }, 100);

            document.getElementById('coupon-modal').classList.remove('hidden');
        }

        function generateQRCode(coupon) {
            const canvas = document.getElementById('qr-code');
            if (!canvas) return;
            
            const qrData = {
                type: 'LEISMO_COUPON',
                code: coupon.code,
                id: coupon.id,
                value: coupon.value,
                couponType: coupon.type,
                created: coupon.createdTimestamp,
                expiry: coupon.expiryTimestamp,
                verification: `leismo-verify-${coupon.code}`
            };

            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(canvas, JSON.stringify(qrData), {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#B19D87',
                        light: '#FFFFFF'
                    },
                    errorCorrectionLevel: 'M'
                }, function(error) {
                    if (error) {
                        console.error('QR Code error:', error);
                    }
                });
            } else {
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#e0e0e0';
                ctx.fillRect(0, 0, 200, 200);
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('QR Code', 100, 100);
            }
        }

        window.closeCouponModal = function() {
            document.getElementById('coupon-modal').classList.add('hidden');
            window.currentCoupon = null;
        };

        window.downloadCoupon = function() {
            alert('ฟีเจอร์ดาวน์โหลดจะพัฒนาในเร็วๆ นี้');
        };

        // Scanner Functions
        window.processQRData = function() {
            const qrInput = document.getElementById('qr-data-input').value.trim();
            
            if (!qrInput) {
                alert('กรุณาใส่ข้อมูล QR Code');
                return;
            }

            try {
                const qrData = JSON.parse(qrInput);
                
                if (qrData.type !== 'LEISMO_COUPON') {
                    throw new Error('ไม่ใช่ QR Code ของคูปอง Leismo');
                }

                showVerificationResult({
                    status: 'valid',
                    coupon: {
                        code: qrData.code,
                        name: 'คูปองส่วนลด',
                        type: qrData.couponType,
                        value: qrData.value,
                        createdDate: 'วันนี้',
                        expiryDate: '7 วันข้างหน้า'
                    },
                    owner: {
                        name: 'ลูกค้าทดสอบ',
                        email: 'customer@test.com',
                        tier: 'Bronze',
                        points: 1500
                    }
                });

            } catch (error) {
                alert('ข้อมูล QR Code ไม่ถูกต้อง');
            }
        };

        function showVerificationResult(result) {
            const container = document.getElementById('coupon-verification-result');
            container.classList.remove('hidden');

            let statusColor, statusIcon, statusText;
            
            switch (result.status) {
                case 'valid':
                    statusColor = 'bg-green-50 border-green-200';
                    statusIcon = '✅';
    </script>
</body>
</html>ูปองใช้ได้';
                    break;
                case 'used':
                    statusColor = 'bg-red-50 border-red-200';
                    statusIcon = '❌';
                    statusText = 'คูปองใช้แล้ว';
                    break;
                case 'expired':
                    statusColor = 'bg-orange-50 border-orange-200';
                    statusIcon = '⏰';
                    statusText = 'คูปองหมดอายุ';
                    break;
            }

            const coupon = result.coupon;
            const owner = result.owner;
            const canUse = result.status === 'valid';

            container.innerHTML = `
                <div class="border-2 rounded-lg p-6 ${statusColor}">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2">${statusIcon}</div>
                        <h3 class="text-xl font-semibold">${statusText}</h3>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">ข้อมูลคูปอง</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>รหัส:</strong> ${coupon.code}</p>
                                <p><strong>ชื่อ:</strong> ${coupon.name}</p>
                                <p><strong>มูลค่า:</strong> ${coupon.type === 'coupon' ? `฿${coupon.value}` : `${coupon.value}%`}</p>
                                <p><strong>ได้รับ:</strong> ${coupon.createdDate}</p>
                                <p><strong>หมดอายุ:</strong> ${coupon.expiryDate}</p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h4 class="font-semibold text-gray-800">ข้อมูลลูกค้า</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>ชื่อ:</strong> ${owner.name}</p>
                                <p><strong>อีเมล:</strong> ${owner.email}</p>
                                <p><strong>ระดับ:</strong> ${owner.tier}</p>
                                <p><strong>แต้มปัจจุบัน:</strong> ${owner.points.toLocaleString()} แต้ม</p>
                            </div>
                        </div>
                    </div>

                    ${canUse ? `
                        <div class="mt-6 text-center">
                            <button onclick="useCoupon('${coupon.code}')" class="bg-green-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-600">
                                ✅ ยืนยันการใช้คูปอง
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        window.useCoupon = function(couponCode) {
            if (confirm(`ยืนยันการใช้คูปอง ${couponCode}?`)) {
                alert('✅ ยืนยันการใช้คูปองสำเร็จ!');
            }
        };

        // Error Functions
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        }

        function hideError(elementId) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showPage('home');
        });
    </script>
</body>
</html>
